<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Santri - Pondok Pesantren</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tambahkan library untuk export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#3b82f6',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        info: '#06b6d4',
                        santri: '#1e3a8a'
                    }
                }
            }
        }
    </script>
    <style>
        .hidden {
            display: none;
        }
        .active-tab {
            background-color: #1e40af;
            color: white;
        }
        .santri-card:hover {
            transform: translateY(-5px);
            transition: transform 0.3s ease;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .badge-hadir { background-color: #d1fae5; color: #065f46; }
        .badge-sakit { background-color: #fef3c7; color: #92400e; }
        .badge-ijin { background-color: #dbeafe; color: #1e40af; }
        .badge-pulang { background-color: #e5e7eb; color: #374151; }
        .badge-baik { background-color: #d1fae5; color: #065f46; }
        .badge-cukup { background-color: #fef3c7; color: #92400e; }
        .badge-kurang { background-color: #fee2e2; color: #991b1b; }
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background-color: #e5e7eb;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        /* Style untuk modal edit */
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        /* Style untuk tombol export */
        .export-btn {
            transition: all 0.2s ease;
        }
        .export-btn:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Login Section -->
    <section id="login-section" class="min-h-screen flex items-center justify-center bg-santri">
        <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <i class="fas fa-mosque text-4xl text-santri mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-800">Login Dashboard Santri</h2>
                <p class="text-gray-600 mt-2">Masuk untuk mengelola data santri</p>
            </div>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="login-email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="login-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                <button type="submit" class="w-full bg-santri text-white py-2 rounded-md hover:bg-primary transition duration-200">
                    Masuk
                </button>
            </form>
            
            <div id="login-message" class="mt-4 text-center text-sm hidden"></div>
        </div>
    </section>

    <!-- Main Application (Hidden until login) -->
    <div id="app-content" class="hidden">
        <!-- Header -->
        <header class="bg-santri text-white shadow-lg">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-mosque text-2xl"></i>
                    <div>
                        <h1 class="text-xl font-bold">Dashboard Santri</h1>
                        <p class="text-sm text-blue-200">Pondok Pesantren Al-Maa</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="current-date" class="text-sm"></span>
                    <div class="flex items-center space-x-2 bg-blue-800 px-3 py-1 rounded-full">
                        <i class="fas fa-user-circle"></i>
                        <span id="user-email">Admin</span>
                        <button id="logout-btn" class="ml-2 text-sm hover:text-blue-200">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-white shadow-md sticky top-0 z-10">
            <div class="container mx-auto">
                <ul class="flex overflow-x-auto">
                    <li><button id="tab-dashboard" class="tab-button active-tab px-4 py-3 font-medium"><i class="fas fa-tachometer-alt mr-2"></i>Dashboard</button></li>
                    <li><button id="tab-data-santri" class="tab-button px-4 py-3 font-medium"><i class="fas fa-users mr-2"></i>Data Santri</button></li>
                    <li><button id="tab-absen" class="tab-button px-4 py-3 font-medium"><i class="fas fa-clipboard-list mr-2"></i>Absensi</button></li>
                    <li><button id="tab-hafalan" class="tab-button px-4 py-3 font-medium"><i class="fas fa-book-quran mr-2"></i>Hafalan</button></li>
                    <li><button id="tab-kesantrian" class="tab-button px-4 py-3 font-medium"><i class="fas fa-user-check mr-2"></i>Kesantrian</button></li>
                    <li><button id="tab-kasus" class="tab-button px-4 py-3 font-medium"><i class="fas fa-exclamation-triangle mr-2"></i>Kasus</button></li>
                    <li><button id="tab-sanksi" class="tab-button px-4 py-3 font-medium"><i class="fas fa-gavel mr-2"></i>Sanksi</button></li>
                </ul>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="container mx-auto my-6 px-4">
            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section fade-in">
                <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-2">Dashboard Overview</h2>
                
                <!-- Statistik -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow p-6 border-l-4 border-blue-500">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 text-primary">
                                <i class="fas fa-users text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Santri</p>
                                <h3 class="text-2xl font-bold" id="total-santri">0</h3>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow p-6 border-l-4 border-green-500">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 text-success">
                                <i class="fas fa-check-circle text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Hadir Hari Ini</p>
                                <h3 class="text-2xl font-bold" id="hadir-hari-ini">0</h3>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow p-6 border-l-4 border-purple-500">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                                <i class="fas fa-book-open text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Halaman Hafalan</p>
                                <h3 class="text-2xl font-bold" id="total-halaman">0</h3>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow p-6 border-l-4 border-red-500">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-red-100 text-danger">
                                <i class="fas fa-exclamation-triangle text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Pelanggaran</p>
                                <h3 class="text-2xl font-bold" id="total-pelanggaran">0</h3>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Grafik dan Data Terbaru -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow p-6">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">Aktivitas Terbaru</h3>
                        <div class="space-y-4" id="recent-activities">
                            <div class="text-center py-4 text-gray-500">
                                <i class="fas fa-spinner fa-spin"></i> Memuat data...
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow p-6">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">Santri Terbaik</h3>
                        <div class="space-y-4" id="top-santri">
                            <div class="text-center py-4 text-gray-500">
                                <i class="fas fa-spinner fa-spin"></i> Memuat data...
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Santri dengan Poin Rendah -->
                <div class="bg-white rounded-xl shadow p-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">Perhatian Khusus</h3>
                    <p class="text-gray-600 mb-4">Santri dengan poin kesantrian rendah memerlukan perhatian lebih</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="low-point-santri">
                        <div class="text-center py-4 text-gray-500">
                            <i class="fas fa-spinner fa-spin"></i> Memuat data...
                        </div>
                    </div>
                </div>
            </section>

            <!-- Data Santri Section -->
            <section id="data-santri" class="content-section hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">Data Santri</h2>
                    <div class="flex space-x-2">
                        <button id="export-santri-pdf" class="export-btn bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg flex items-center shadow">
                            <i class="fas fa-file-pdf mr-2"></i> Export PDF
                        </button>
                        <button id="export-santri-excel" class="export-btn bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg flex items-center shadow">
                            <i class="fas fa-file-excel mr-2"></i> Export Excel
                        </button>
                        <button id="tambah-santri-btn" class="bg-primary hover:bg-santri text-white px-4 py-2 rounded-lg flex items-center shadow">
                            <i class="fas fa-plus mr-2"></i> Tambah Santri
                        </button>
                    </div>
                </div>
                
                <!-- Form Tambah Santri -->
                <div id="form-tambah-santri" class="bg-white rounded-xl shadow p-6 mb-6 hidden">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">Tambah Santri Baru</h3>
                    <form id="santri-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nama Santri</label>
                            <input type="text" id="nama-santri" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                            <input type="text" id="kelas-santri" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Asal</label>
                            <input type="text" id="asal-santri" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Umur</label>
                            <input type="number" id="umur-santri" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Masuk</label>
                            <input type="date" id="tanggal-masuk" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nama Wali</label>
                            <input type="text" id="nama-wali" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div class="md:col-span-2 flex justify-end space-x-2 mt-2">
                            <button type="button" id="batal-tambah" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-santri">Simpan</button>
                        </div>
                    </form>
                </div>
                
                <!-- Tabel Santri -->
                <div class="bg-white rounded-xl shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Umur</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Poin</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="santri-table-body" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                        <i class="fas fa-spinner fa-spin"></i> Memuat data santri...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Absen Kesantrian Section -->
            <section id="absen" class="content-section hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">Absensi Santri</h2>
                    <div class="flex space-x-2">
                        <button id="export-absen-pdf" class="export-btn bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg flex items-center shadow">
                            <i class="fas fa-file-pdf mr-2"></i> Export PDF
                        </button>
                        <button id="export-absen-excel" class="export-btn bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg flex items-center shadow">
                            <i class="fas fa-file-excel mr-2"></i> Export Excel
                        </button>
                    </div>
                </div>
                
                <!-- Form Absen -->
                <div class="bg-white rounded-xl shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">Input Absensi Harian</h3>
                    <form id="absen-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Pilih Santri</label>
                            <select id="santri-absen" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                                <option value="">Memuat data santri...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                            <input type="date" id="tanggal-absen" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select id="status-absen" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                                <option value="hadir">Hadir</option>
                                <option value="sakit">Sakit</option>
                                <option value="ijin">Ijin</option>
                                <option value="pulang">Pulang</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
                            <input type="text" id="keterangan-absen" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Opsional">
                        </div>
                        <div class="md:col-span-2 flex justify-end">
                            <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-santri">Simpan Absensi</button>
                        </div>
                    </form>
                </div>
                
                <!-- Tabel Absensi -->
                <div class="bg-white rounded-xl shadow overflow-hidden">
                    <div class="p-4 border-b flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-800">Riwayat Absensi</h3>
                        <div class="flex space-x-2">
                            <input type="date" id="filter-tanggal-absen" class="px-3 py-1 border border-gray-300 rounded-md">
                            <button id="filter-absen" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">Filter</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Santri</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="absen-table-body" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                        <i class="fas fa-spinner fa-spin"></i> Memuat data absensi...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Setoran Hafalan Section -->
            <section id="hafalan" class="content-section hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">Setoran Hafalan</h2>
                    <div class="flex space-x-2">
                        <button id="export-hafalan-pdf" class="export-btn bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg flex items-center shadow">
                            <i class="fas fa-file-pdf mr-2"></i> Export PDF
                        </button>
                        <button id="export-hafalan-excel" class="export-btn bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg flex items-center shadow">
                            <i class="fas fa-file-excel mr-2"></i> Export Excel
                        </button>
                    </div>
                </div>
                
                <!-- Form Setoran Hafalan -->
                <div class="bg-white rounded-xl shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">Input Setoran Hafalan</h3>
                    <form id="hafalan-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Pilih Santri</label>
                            <select id="santri-hafalan" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                                <option value="">Memuat data santri...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                            <input type="date" id="tanggal-hafalan" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Halaman Awal</label>
                            <input type="number" id="halaman-awal" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Halaman Akhir</label>
                            <input type="number" id="halaman-akhir" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Catatan</label>
                            <textarea id="catatan-hafalan" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" rows="3" placeholder="Catatan tentang hafalan santri"></textarea>
                        </div>
                        <div class="md:col-span-2 flex justify-end">
                            <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-santri">Simpan Setoran</button>
                        </div>
                    </form>
                </div>
                
                <!-- Tabel Setoran Hafalan -->
                <div class="bg-white rounded-xl shadow overflow-hidden">
                    <div class="p-4 border-b flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-800">Riwayat Setoran Hafalan</h3>
                        <div class="flex space-x-2">
                            <select id="filter-santri-hafalan" class="px-3 py-1 border border-gray-300 rounded-md">
                                <option value="">Semua Santri</option>
                            </select>
                            <button id="filter-hafalan" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">Filter</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Santri</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Halaman</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Catatan</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="hafalan-table-body" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                        <i class="fas fa-spinner fa-spin"></i> Memuat data hafalan...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Kesantrian Section -->
            <section id="kesantrian" class="content-section hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">Penilaian Kesantrian</h2>
                    <div class="flex space-x-2">
                        <button id="export-kesantrian-pdf" class="export-btn bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg flex items-center shadow">
                            <i class="fas fa-file-pdf mr-2"></i> Export PDF
                        </button>
                        <button id="export-kesantrian-excel" class="export-btn bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg flex items-center shadow">
                            <i class="fas fa-file-excel mr-2"></i> Export Excel
                        </button>
                    </div>
                </div>
                
                <!-- Form Penilaian Kesantrian -->
                <div class="bg-white rounded-xl shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">Input Penilaian Kesantrian</h3>
                    <form id="kesantrian-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Pilih Santri</label>
                            <select id="santri-kesantrian" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                                <option value="">Memuat data santri...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                            <input type="date" id="tanggal-kesantrian" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sikap</label>
                            <select id="sikap-kesantrian" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                                <option value="baik">Baik</option>
                                <option value="cukup">Cukup</option>
                                <option value="kurang">Kurang</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Disiplin</label>
                            <select id="disiplin-kesantrian" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                                <option value="baik">Baik</option>
                                <option value="cukup">Cukup</option>
                                <option value="kurang">Kurang</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kebersihan & Kerapihan</label>
                            <select id="kebersihan-kesantrian" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                                <option value="baik">Baik</option>
                                <option value="cukup">Cukup</option>
                                <option value="kurang">Kurang</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Pelanggaran (opsional)</label>
                            <input type="text" id="pelanggaran-kesantrian" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Jenis pelanggaran jika ada">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Catatan</label>
                            <textarea id="catatan-kesantrian" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" rows="3" placeholder="Catatan tambahan tentang kesantrian"></textarea>
                        </div>
                        <div class="md:col-span-2 flex justify-end">
                            <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-santri">Simpan Penilaian</button>
                        </div>
                    </form>
                </div>
                
                <!-- Tabel Penilaian Kesantrian -->
                <div class="bg-white rounded-xl shadow overflow-hidden">
                    <div class="p-4 border-b flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-800">Riwayat Penilaian Kesantrian</h3>
                        <div class="flex space-x-2">
                            <select id="filter-santri-kesantrian" class="px-3 py-1 border border-gray-300 rounded-md">
                                <option value="">Semua Santri</option>
                            </select>
                            <button id="filter-kesantrian" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">Filter</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Santri</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sikap</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Disiplin</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kebersihan</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Catatan</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="kesantrian-table-body" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                                        <i class="fas fa-spinner fa-spin"></i> Memuat data kesantrian...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Kasus & Penanganan Section -->
            <section id="kasus" class="content-section hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">Kasus & Penanganan</h2>
                    <div class="flex space-x-2">
                        <button id="export-kasus-pdf" class="export-btn bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg flex items-center shadow">
                            <i class="fas fa-file-pdf mr-2"></i> Export PDF
                        </button>
                        <button id="export-kasus-excel" class="export-btn bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg flex items-center shadow">
                            <i class="fas fa-file-excel mr-2"></i> Export Excel
                        </button>
                    </div>
                </div>
                
                <!-- Form Kasus -->
                <div class="bg-white rounded-xl shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">Input Kasus & Penanganan</h3>
                    <form id="kasus-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Pilih Santri</label>
                            <select id="santri-kasus" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                                <option value="">Memuat data santri...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                            <input type="date" id="tanggal-kasus" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kasus</label>
                            <textarea id="deskripsi-kasus" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" rows="3" required placeholder="Deskripsi kasus yang terjadi"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Penanganan</label>
                            <textarea id="penanganan-kasus" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" rows="3" required placeholder="Tindakan penanganan yang dilakukan"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Poin yang Dikurangi</label>
                            <input type="number" id="poin-kasus" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" min="0" max="100" value="0">
                        </div>
                        <div class="md:col-span-2 flex justify-end">
                            <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-santri">Simpan Kasus</button>
                        </div>
                    </form>
                </div>
                
                <!-- Tabel Kasus -->
                <div class="bg-white rounded-xl shadow overflow-hidden">
                    <div class="p-4 border-b flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-800">Riwayat Kasus & Penanganan</h3>
                        <div class="flex space-x-2">
                            <select id="filter-santri-kasus" class="px-3 py-1 border border-gray-300 rounded-md">
                                <option value="">Semua Santri</option>
                            </select>
                            <button id="filter-kasus" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">Filter</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Santri</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kasus</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Penanganan</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Poin</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="kasus-table-body" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                        <i class="fas fa-spinner fa-spin"></i> Memuat data kasus...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Sanksi & Pelanggaran Section -->
            <section id="sanksi" class="content-section hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">Sanksi & Pelanggaran</h2>
                    <div class="flex space-x-2">
                        <button id="export-pelanggaran-pdf" class="export-btn bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg flex items-center shadow">
                            <i class="fas fa-file-pdf mr-2"></i> Export PDF
                        </button>
                        <button id="export-pelanggaran-excel" class="export-btn bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg flex items-center shadow">
                            <i class="fas fa-file-excel mr-2"></i> Export Excel
                        </button>
                    </div>
                </div>
                
                <!-- Form Input Pelanggaran -->
                <div class="bg-white rounded-xl shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">Input Pelanggaran Santri</h3>
                    <form id="pelanggaran-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Pilih Santri</label>
                            <select id="santri-pelanggaran" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                                <option value="">Memuat data santri...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                            <input type="date" id="tanggal-pelanggaran" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Pelanggaran</label>
                            <select id="jenis-pelanggaran" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                                <option value="">Pilih jenis pelanggaran...</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Deskripsi Pelanggaran</label>
                            <textarea id="deskripsi-pelanggaran" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" rows="3" required placeholder="Deskripsi detail pelanggaran yang dilakukan"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sanksi Fisik yang Diberikan</label>
                            <textarea id="sanksi-fisik" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" rows="2" placeholder="Sanksi fisik yang telah diberikan"></textarea>
                        </div>
                        <div class="md:col-span-2 bg-yellow-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-yellow-800 mb-2">Informasi Sanksi</h4>
                            <div id="info-sanksi" class="text-sm text-yellow-700">
                                Pilih jenis pelanggaran untuk melihat informasi sanksi
                            </div>
                        </div>
                        <div class="md:col-span-2 flex justify-end">
                            <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-santri">Simpan Pelanggaran</button>
                        </div>
                    </form>
                </div>
                
                <!-- Daftar Pelanggaran -->
                <div class="bg-white rounded-xl shadow overflow-hidden mb-6">
                    <div class="p-4 border-b flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-800">Riwayat Pelanggaran</h3>
                        <div class="flex space-x-2">
                            <select id="filter-santri-pelanggaran" class="px-3 py-1 border border-gray-300 rounded-md">
                                <option value="">Semua Santri</option>
                            </select>
                            <select id="filter-bab-pelanggaran" class="px-3 py-1 border border-gray-300 rounded-md">
                                <option value="">Semua Bab</option>
                            </select>
                            <button id="filter-pelanggaran" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">Filter</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Santri</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pelanggaran</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pengurangan Point</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sanksi Fisik</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="pelanggaran-table-body" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                        <i class="fas fa-spinner fa-spin"></i> Memuat data pelanggaran...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Kategori Pelanggaran -->
                <div class="bg-white rounded-xl shadow overflow-hidden">
                    <div class="p-4 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">Kategori Pelanggaran</h3>
                    </div>
                    <div class="p-4">
                        <div id="kategori-pelanggaran" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="text-center py-4 text-gray-500">
                                <i class="fas fa-spinner fa-spin"></i> Memuat data kategori...
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Modal Detail Santri -->
        <div id="modal-santri" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
            <div class="bg-white rounded-xl shadow-xl w-11/12 md:w-4/5 lg:w-3/4 max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800" id="modal-nama-santri">Detail Santri</h3>
                        <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <!-- Informasi Pribadi -->
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-3 text-blue-800 flex items-center">
                                <i class="fas fa-user-circle mr-2"></i> Informasi Pribadi
                            </h4>
                            <div class="space-y-2">
                                <p><span class="font-medium text-gray-700">Kelas:</span> <span id="modal-kelas">-</span></p>
                                <p><span class="font-medium text-gray-700">Asal:</span> <span id="modal-asal">-</span></p>
                                <p><span class="font-medium text-gray-700">Umur:</span> <span id="modal-umur">-</span></p>
                                <p><span class="font-medium text-gray-700">Tanggal Masuk:</span> <span id="modal-tanggal-masuk">-</span></p>
                                <p><span class="font-medium text-gray-700">Nama Wali:</span> <span id="modal-nama-wali">-</span></p>
                            </div>
                        </div>
                        
                        <!-- Poin Kesantrian -->
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-3 text-green-800 flex items-center">
                                <i class="fas fa-star mr-2"></i> Poin Kesantrian
                            </h4>
                            <div class="text-center">
                                <div class="text-3xl font-bold mb-2" id="modal-poin">-</div>
                                <div class="progress-bar">
                                    <div id="modal-poin-progress" class="progress-fill bg-green-500"></div>
                                </div>
                                <p class="text-sm text-gray-600 mt-2">Poin saat ini</p>
                            </div>
                        </div>
                        
                        <!-- Statistik Hafalan -->
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-3 text-purple-800 flex items-center">
                                <i class="fas fa-book-quran mr-2"></i> Statistik Hafalan
                            </h4>
                            <div class="space-y-2">
                                <p><span class="font-medium text-gray-700">Total Halaman:</span> <span id="modal-total-halaman">0</span></p>
                                <p><span class="font-medium text-gray-700">Setoran Terakhir:</span> <span id="modal-setoran-terakhir">-</span></p>
                                <p><span class="font-medium text-gray-700">Rata-rata per Bulan:</span> <span id="modal-rata-hafalan">0</span> halaman</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Riwayat Absensi -->
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <h4 class="font-semibold mb-3 text-gray-800 flex items-center">
                                <i class="fas fa-clipboard-list mr-2"></i> Riwayat Absensi (30 hari terakhir)
                            </h4>
                            <div id="modal-absensi" class="space-y-2 max-h-60 overflow-y-auto">
                                <div class="text-center py-4 text-gray-500">
                                    <i class="fas fa-spinner fa-spin"></i> Memuat data...
                                </div>
                            </div>
                        </div>
                        
                        <!-- Setoran Hafalan -->
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <h4 class="font-semibold mb-3 text-gray-800 flex items-center">
                                <i class="fas fa-book-open mr-2"></i> Setoran Hafalan Terbaru
                            </h4>
                            <div id="modal-hafalan" class="space-y-3 max-h-60 overflow-y-auto">
                                <div class="text-center py-4 text-gray-500">
                                    <i class="fas fa-spinner fa-spin"></i> Memuat data...
                                </div>
                            </div>
                        </div>
                        
                        <!-- Penilaian Kesantrian -->
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <h4 class="font-semibold mb-3 text-gray-800 flex items-center">
                                <i class="fas fa-user-check mr-2"></i> Penilaian Kesantrian Terbaru
                            </h4>
                            <div id="modal-kesantrian" class="space-y-3 max-h-60 overflow-y-auto">
                                <div class="text-center py-4 text-gray-500">
                                    <i class="fas fa-spinner fa-spin"></i> Memuat data...
                                </div>
                            </div>
                        </div>
                        
                        <!-- Kasus & Penanganan -->
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <h4 class="font-semibold mb-3 text-gray-800 flex items-center">
                                <i class="fas fa-exclamation-triangle mr-2"></i> Kasus & Penanganan
                            </h4>
                            <div id="modal-kasus" class="space-y-3 max-h-60 overflow-y-auto">
                                <div class="text-center py-4 text-gray-500">
                                    <i class="fas fa-spinner fa-spin"></i> Memuat data...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Edit Santri -->
        <div id="modal-edit-santri" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
            <div class="bg-white rounded-xl shadow-xl w-11/12 md:w-3/4 lg:w-1/2 max-h-screen overflow-y-auto modal-content">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">Edit Data Santri</h3>
                        <button id="close-edit-modal" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <form id="edit-santri-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="edit-santri-id">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nama Santri</label>
                            <input type="text" id="edit-nama-santri" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                            <input type="text" id="edit-kelas-santri" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Asal</label>
                            <input type="text" id="edit-asal-santri" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Umur</label>
                            <input type="number" id="edit-umur-santri" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Masuk</label>
                            <input type="date" id="edit-tanggal-masuk" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nama Wali</label>
                            <input type="text" id="edit-nama-wali" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Poin Kesantrian</label>
                            <input type="number" id="edit-poin-santri" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" min="0" max="100" required>
                        </div>
                        <div class="md:col-span-2 flex justify-end space-x-2 mt-2">
                            <button type="button" id="batal-edit" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-santri">Update</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal Edit Absensi -->
        <div id="modal-edit-absensi" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
            <div class="bg-white rounded-xl shadow-xl w-11/12 md:w-3/4 lg:w-1/2 max-h-screen overflow-y-auto modal-content">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">Edit Data Absensi</h3>
                        <button id="close-edit-absensi-modal" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <form id="edit-absensi-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="edit-absensi-id">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                            <input type="date" id="edit-tanggal-absensi" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select id="edit-status-absensi" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                                <option value="hadir">Hadir</option>
                                <option value="sakit">Sakit</option>
                                <option value="ijin">Ijin</option>
                                <option value="pulang">Pulang</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
                            <input type="text" id="edit-keterangan-absensi" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Opsional">
                        </div>
                        <div class="md:col-span-2 flex justify-end space-x-2 mt-2">
                            <button type="button" id="batal-edit-absensi" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-santri">Update</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal Edit Hafalan -->
        <div id="modal-edit-hafalan" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
            <div class="bg-white rounded-xl shadow-xl w-11/12 md:w-3/4 lg:w-1/2 max-h-screen overflow-y-auto modal-content">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">Edit Data Hafalan</h3>
                        <button id="close-edit-hafalan-modal" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <form id="edit-hafalan-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="edit-hafalan-id">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                            <input type="date" id="edit-tanggal-hafalan" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Halaman Awal</label>
                            <input type="number" id="edit-halaman-awal" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Halaman Akhir</label>
                            <input type="number" id="edit-halaman-akhir" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Catatan</label>
                            <textarea id="edit-catatan-hafalan" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" rows="3" placeholder="Catatan tentang hafalan santri"></textarea>
                        </div>
                        <div class="md:col-span-2 flex justify-end space-x-2 mt-2">
                            <button type="button" id="batal-edit-hafalan" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-santri">Update</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal Edit Kesantrian -->
        <div id="modal-edit-kesantrian" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
            <div class="bg-white rounded-xl shadow-xl w-11/12 md:w-3/4 lg:w-1/2 max-h-screen overflow-y-auto modal-content">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">Edit Data Kesantrian</h3>
                        <button id="close-edit-kesantrian-modal" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <form id="edit-kesantrian-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="edit-kesantrian-id">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                            <input type="date" id="edit-tanggal-kesantrian" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sikap</label>
                            <select id="edit-sikap-kesantrian" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                                <option value="baik">Baik</option>
                                <option value="cukup">Cukup</option>
                                <option value="kurang">Kurang</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Disiplin</label>
                            <select id="edit-disiplin-kesantrian" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                                <option value="baik">Baik</option>
                                <option value="cukup">Cukup</option>
                                <option value="kurang">Kurang</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kebersihan & Kerapihan</label>
                            <select id="edit-kebersihan-kesantrian" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                                <option value="baik">Baik</option>
                                <option value="cukup">Cukup</option>
                                <option value="kurang">Kurang</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Pelanggaran (opsional)</label>
                            <input type="text" id="edit-pelanggaran-kesantrian" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Jenis pelanggaran jika ada">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Catatan</label>
                            <textarea id="edit-catatan-kesantrian" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" rows="3" placeholder="Catatan tambahan tentang kesantrian"></textarea>
                        </div>
                        <div class="md:col-span-2 flex justify-end space-x-2 mt-2">
                            <button type="button" id="batal-edit-kesantrian" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-santri">Update</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal Edit Kasus -->
        <div id="modal-edit-kasus" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
            <div class="bg-white rounded-xl shadow-xl w-11/12 md:w-3/4 lg:w-1/2 max-h-screen overflow-y-auto modal-content">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">Edit Data Kasus</h3>
                        <button id="close-edit-kasus-modal" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <form id="edit-kasus-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="edit-kasus-id">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                            <input type="date" id="edit-tanggal-kasus" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Poin yang Dikurangi</label>
                            <input type="number" id="edit-poin-kasus" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" min="0" max="100" value="0">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kasus</label>
                            <textarea id="edit-deskripsi-kasus" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" rows="3" required placeholder="Deskripsi kasus yang terjadi"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Penanganan</label>
                            <textarea id="edit-penanganan-kasus" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" rows="3" required placeholder="Tindakan penanganan yang dilakukan"></textarea>
                        </div>
                        <div class="md:col-span-2 flex justify-end space-x-2 mt-2">
                            <button type="button" id="batal-edit-kasus" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-santri">Update</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal Edit Pelanggaran -->
        <div id="modal-edit-pelanggaran" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
            <div class="bg-white rounded-xl shadow-xl w-11/12 md:w-3/4 lg:w-1/2 max-h-screen overflow-y-auto modal-content">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">Edit Data Pelanggaran</h3>
                        <button id="close-edit-pelanggaran-modal" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <form id="edit-pelanggaran-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="edit-pelanggaran-id">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                            <input type="date" id="edit-tanggal-pelanggaran" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Pelanggaran</label>
                            <select id="edit-jenis-pelanggaran" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                                <option value="">Pilih jenis pelanggaran...</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Deskripsi Pelanggaran</label>
                            <textarea id="edit-deskripsi-pelanggaran" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" rows="3" required placeholder="Deskripsi detail pelanggaran yang dilakukan"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sanksi Fisik yang Diberikan</label>
                            <textarea id="edit-sanksi-fisik" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" rows="2" placeholder="Sanksi fisik yang telah diberikan"></textarea>
                        </div>
                        <div class="md:col-span-2 flex justify-end space-x-2 mt-2">
                            <button type="button" id="batal-edit-pelanggaran" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-santri">Update</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Konfirmasi Hapus Modal -->
        <div id="modal-hapus" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
            <div class="bg-white rounded-xl shadow-xl w-11/12 md:w-1/2 max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">Konfirmasi Hapus</h3>
                        <button id="close-hapus-modal" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-gray-700">Apakah Anda yakin ingin menghapus data ini? Tindakan ini tidak dapat dibatalkan.</p>
                    </div>
                    
                    <div class="flex justify-end space-x-2">
                        <button id="batal-hapus" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100">Batal</button>
                        <button id="konfirmasi-hapus" class="px-4 py-2 bg-danger text-white rounded-md hover:bg-red-600">Hapus</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <script>
        // Inisialisasi Supabase
        const SUPABASE_URL = 'https://pwkajpjrtheglmkgfige.supabase.co'; // Ganti dengan URL Supabase Anda
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3a2FqcGpydGhlZ2xta2dmaWdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTA2NDUsImV4cCI6MjA3ODcyNjY0NX0.I8vvCewUPrRbBs86AiJ46CWxOKf3T21msbQCETYmmI4'; // Ganti dengan anon key Anda
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // State aplikasi
        let currentUser = null;
        let santriData = [];
        let absensiData = [];
        let hafalanData = [];
        let kesantrianData = [];
        let kasusData = [];
        let pelanggaranData = [];
        let jenisPelanggaranData = [];
        let currentEditId = null;
        let currentEditType = null;

        // DOM Elements
        const loginSection = document.getElementById('login-section');
        const appContent = document.getElementById('app-content');
        const loginForm = document.getElementById('login-form');
        const loginMessage = document.getElementById('login-message');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmail = document.getElementById('user-email');
        const currentDateElement = document.getElementById('current-date');
        const tabButtons = document.querySelectorAll('.tab-button');
        const contentSections = document.querySelectorAll('.content-section');
        
        // Dashboard Elements
        const totalSantriElement = document.getElementById('total-santri');
        const hadirHariIniElement = document.getElementById('hadir-hari-ini');
        const totalHalamanElement = document.getElementById('total-halaman');
        const totalPelanggaranElement = document.getElementById('total-pelanggaran');
        const recentActivitiesElement = document.getElementById('recent-activities');
        const topSantriElement = document.getElementById('top-santri');
        const lowPointSantriElement = document.getElementById('low-point-santri');
        
        // Data Santri Elements
        const tambahSantriBtn = document.getElementById('tambah-santri-btn');
        const formTambahSantri = document.getElementById('form-tambah-santri');
        const santriForm = document.getElementById('santri-form');
        const batalTambah = document.getElementById('batal-tambah');
        const santriTableBody = document.getElementById('santri-table-body');
        
        // Export Elements
        const exportSantriPdfBtn = document.getElementById('export-santri-pdf');
        const exportSantriExcelBtn = document.getElementById('export-santri-excel');
        const exportAbsenPdfBtn = document.getElementById('export-absen-pdf');
        const exportAbsenExcelBtn = document.getElementById('export-absen-excel');
        const exportHafalanPdfBtn = document.getElementById('export-hafalan-pdf');
        const exportHafalanExcelBtn = document.getElementById('export-hafalan-excel');
        const exportKesantrianPdfBtn = document.getElementById('export-kesantrian-pdf');
        const exportKesantrianExcelBtn = document.getElementById('export-kesantrian-excel');
        const exportKasusPdfBtn = document.getElementById('export-kasus-pdf');
        const exportKasusExcelBtn = document.getElementById('export-kasus-excel');
        const exportPelanggaranPdfBtn = document.getElementById('export-pelanggaran-pdf');
        const exportPelanggaranExcelBtn = document.getElementById('export-pelanggaran-excel');
        
        // Absensi Elements
        const absenForm = document.getElementById('absen-form');
        const santriAbsenSelect = document.getElementById('santri-absen');
        const absenTableBody = document.getElementById('absen-table-body');
        const filterTanggalAbsen = document.getElementById('filter-tanggal-absen');
        const filterAbsenBtn = document.getElementById('filter-absen');
        
        // Hafalan Elements
        const hafalanForm = document.getElementById('hafalan-form');
        const santriHafalanSelect = document.getElementById('santri-hafalan');
        const hafalanTableBody = document.getElementById('hafalan-table-body');
        const filterSantriHafalan = document.getElementById('filter-santri-hafalan');
        const filterHafalanBtn = document.getElementById('filter-hafalan');
        
        // Kesantrian Elements
        const kesantrianForm = document.getElementById('kesantrian-form');
        const santriKesantrianSelect = document.getElementById('santri-kesantrian');
        const kesantrianTableBody = document.getElementById('kesantrian-table-body');
        const filterSantriKesantrian = document.getElementById('filter-santri-kesantrian');
        const filterKesantrianBtn = document.getElementById('filter-kesantrian');
        
        // Kasus Elements
        const kasusForm = document.getElementById('kasus-form');
        const santriKasusSelect = document.getElementById('santri-kasus');
        const kasusTableBody = document.getElementById('kasus-table-body');
        const filterSantriKasus = document.getElementById('filter-santri-kasus');
        const filterKasusBtn = document.getElementById('filter-kasus');
        
        // Sanksi Elements
        const pelanggaranForm = document.getElementById('pelanggaran-form');
        const santriPelanggaranSelect = document.getElementById('santri-pelanggaran');
        const jenisPelanggaranSelect = document.getElementById('jenis-pelanggaran');
        const pelanggaranTableBody = document.getElementById('pelanggaran-table-body');
        const filterSantriPelanggaran = document.getElementById('filter-santri-pelanggaran');
        const filterBabPelanggaran = document.getElementById('filter-bab-pelanggaran');
        const filterPelanggaranBtn = document.getElementById('filter-pelanggaran');
        const infoSanksi = document.getElementById('info-sanksi');
        const kategoriPelanggaranElement = document.getElementById('kategori-pelanggaran');
        
        // Modal Elements
        const modalSantri = document.getElementById('modal-santri');
        const closeModal = document.getElementById('close-modal');
        const modalNamaSantri = document.getElementById('modal-nama-santri');
        const modalKelas = document.getElementById('modal-kelas');
        const modalAsal = document.getElementById('modal-asal');
        const modalUmur = document.getElementById('modal-umur');
        const modalPoin = document.getElementById('modal-poin');
        const modalPoinProgress = document.getElementById('modal-poin-progress');
        const modalTanggalMasuk = document.getElementById('modal-tanggal-masuk');
        const modalNamaWali = document.getElementById('modal-nama-wali');
        const modalTotalHalaman = document.getElementById('modal-total-halaman');
        const modalSetoranTerakhir = document.getElementById('modal-setoran-terakhir');
        const modalRataHafalan = document.getElementById('modal-rata-hafalan');
        const modalAbsensi = document.getElementById('modal-absensi');
        const modalHafalan = document.getElementById('modal-hafalan');
        const modalKesantrian = document.getElementById('modal-kesantrian');
        const modalKasus = document.getElementById('modal-kasus');
        
        // Edit Modal Elements
        const modalEditSantri = document.getElementById('modal-edit-santri');
        const closeEditModal = document.getElementById('close-edit-modal');
        const editSantriForm = document.getElementById('edit-santri-form');
        const batalEdit = document.getElementById('batal-edit');
        
        const modalEditAbsensi = document.getElementById('modal-edit-absensi');
        const closeEditAbsensiModal = document.getElementById('close-edit-absensi-modal');
        const editAbsensiForm = document.getElementById('edit-absensi-form');
        const batalEditAbsensi = document.getElementById('batal-edit-absensi');
        
        const modalEditHafalan = document.getElementById('modal-edit-hafalan');
        const closeEditHafalanModal = document.getElementById('close-edit-hafalan-modal');
        const editHafalanForm = document.getElementById('edit-hafalan-form');
        const batalEditHafalan = document.getElementById('batal-edit-hafalan');
        
        const modalEditKesantrian = document.getElementById('modal-edit-kesantrian');
        const closeEditKesantrianModal = document.getElementById('close-edit-kesantrian-modal');
        const editKesantrianForm = document.getElementById('edit-kesantrian-form');
        const batalEditKesantrian = document.getElementById('batal-edit-kesantrian');
        
        const modalEditKasus = document.getElementById('modal-edit-kasus');
        const closeEditKasusModal = document.getElementById('close-edit-kasus-modal');
        const editKasusForm = document.getElementById('edit-kasus-form');
        const batalEditKasus = document.getElementById('batal-edit-kasus');
        
        const modalEditPelanggaran = document.getElementById('modal-edit-pelanggaran');
        const closeEditPelanggaranModal = document.getElementById('close-edit-pelanggaran-modal');
        const editPelanggaranForm = document.getElementById('edit-pelanggaran-form');
        const batalEditPelanggaran = document.getElementById('batal-edit-pelanggaran');
        
        // Hapus Modal Elements
        const modalHapus = document.getElementById('modal-hapus');
        const closeHapusModal = document.getElementById('close-hapus-modal');
        const batalHapus = document.getElementById('batal-hapus');
        const konfirmasiHapus = document.getElementById('konfirmasi-hapus');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date
            const now = new Date();
            currentDateElement.textContent = now.toLocaleDateString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Set default date values to today
            document.getElementById('tanggal-absen').valueAsDate = now;
            document.getElementById('tanggal-hafalan').valueAsDate = now;
            document.getElementById('tanggal-kesantrian').valueAsDate = now;
            document.getElementById('tanggal-kasus').valueAsDate = now;
            document.getElementById('tanggal-masuk').valueAsDate = now;
            document.getElementById('tanggal-pelanggaran').valueAsDate = now;
            if (filterTanggalAbsen) filterTanggalAbsen.valueAsDate = now;
            
            // Check if user is already logged in
            checkAuthState();
            
            // Setup event listeners
            setupEventListeners();
        });

        // Authentication Functions
        async function checkAuthState() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                showApp();
            } else {
                showLogin();
            }
        }

        async function handleLogin(email, password) {
            try {
                showLoading(loginForm, true);
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                currentUser = data.user;
                showApp();
                showMessage('Login berhasil!', 'success');
            } catch (error) {
                console.error('Login error:', error);
                showMessage('Login gagal: ' + error.message, 'error');
            } finally {
                showLoading(loginForm, false);
            }
        }

        async function handleLogout() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Logout error:', error);
            }
            currentUser = null;
            showLogin();
        }

        function showLogin() {
            loginSection.classList.remove('hidden');
            appContent.classList.add('hidden');
        }

        function showApp() {
            loginSection.classList.add('hidden');
            appContent.classList.remove('hidden');
            userEmail.textContent = currentUser?.email || 'Admin';
            
            // Load initial data
            loadAllData();
        }

        // Data Functions
        async function loadAllData() {
            try {
                await Promise.all([
                    loadSantriData(),
                    loadAbsensiData(),
                    loadHafalanData(),
                    loadKesantrianData(),
                    loadKasusData(),
                    loadPelanggaranData(),
                    loadJenisPelanggaran()
                ]);
                
                // Sinkronisasi poin
                await updateAllSantriPoints();
                
                updateSantriDropdowns();
                loadDashboardData();
                loadSantriTable();
                loadAbsensiTable();
                loadHafalanTable();
                loadKesantrianTable();
                loadKasusTable();
                loadPelanggaranTable();
                loadKategoriView();
            } catch (error) {
                console.error('Error loading data:', error);
                showMessage('Gagal memuat data: ' + error.message, 'error');
            }
        }

        async function loadSantriData() {
            const { data, error } = await supabase
                .from('profiles')
                .select('*')
                .order('nama_lengkap');
            
            if (error) throw error;
            santriData = data || [];
        }

        async function loadAbsensiData() {
            const { data, error } = await supabase
                .from('absensi')
                .select('*, profiles(nama_lengkap)')
                .order('tanggal', { ascending: false });
            
            if (error) throw error;
            absensiData = data || [];
        }

        async function loadHafalanData() {
            const { data, error } = await supabase
                .from('hafalan')
                .select('*, profiles(nama_lengkap)')
                .order('tanggal', { ascending: false });
            
            if (error) throw error;
            hafalanData = data || [];
        }

        async function loadKesantrianData() {
            const { data, error } = await supabase
                .from('kesantrian')
                .select('*, profiles(nama_lengkap)')
                .order('tanggal', { ascending: false });
            
            if (error) throw error;
            kesantrianData = data || [];
        }

        async function loadKasusData() {
            const { data, error } = await supabase
                .from('kasus')
                .select('*, profiles(nama_lengkap)')
                .order('tanggal', { ascending: false });
            
            if (error) throw error;
            kasusData = data || [];
        }

        async function loadPelanggaranData() {
            const { data, error } = await supabase
                .from('pelanggaran')
                .select('*, profiles(nama_lengkap), jenis_pelanggaran(kode, deskripsi, pengurangan_point, sanksi_fisik, kategori_pelanggaran(bab, nama_bab))')
                .order('tanggal', { ascending: false });
            
            if (error) throw error;
            pelanggaranData = data || [];
        }

        async function loadJenisPelanggaran() {
            const { data, error } = await supabase
                .from('jenis_pelanggaran')
                .select('*, kategori_pelanggaran(bab, nama_bab)')
                .order('kode');
            
            if (error) throw error;
            jenisPelanggaranData = data || [];
            updateJenisPelanggaranDropdown();
            return data || [];
        }

        async function loadKategoriPelanggaran() {
            const { data, error } = await supabase
                .from('kategori_pelanggaran')
                .select('*')
                .order('bab');
            
            if (error) throw error;
            return data || [];
        }

        // CRUD Operations
        async function createSantri(santriData) {
            const { data, error } = await supabase
                .from('profiles')
                .insert([santriData])
                .select();
            
            if (error) throw error;
            return data[0];
        }

        async function updateSantri(id, santriData) {
            const { data, error } = await supabase
                .from('profiles')
                .update(santriData)
                .eq('id', id)
                .select();
            
            if (error) throw error;
            return data[0];
        }

        async function deleteSantri(id) {
            const { error } = await supabase
                .from('profiles')
                .delete()
                .eq('id', id);
            
            if (error) throw error;
        }

        async function createAbsensi(absensiData) {
            const { data, error } = await supabase
                .from('absensi')
                .insert([absensiData])
                .select();
            
            if (error) throw error;
            return data[0];
        }

        async function updateAbsensi(id, absensiData) {
            const { data, error } = await supabase
                .from('absensi')
                .update(absensiData)
                .eq('id', id)
                .select();
            
            if (error) throw error;
            return data[0];
        }

        async function deleteAbsensi(id) {
            const { error } = await supabase
                .from('absensi')
                .delete()
                .eq('id', id);
            
            if (error) throw error;
        }

        async function createHafalan(hafalanData) {
            const { data, error } = await supabase
                .from('hafalan')
                .insert([hafalanData])
                .select();
            
            if (error) throw error;
            return data[0];
        }

        async function updateHafalan(id, hafalanData) {
            const { data, error } = await supabase
                .from('hafalan')
                .update(hafalanData)
                .eq('id', id)
                .select();
            
            if (error) throw error;
            return data[0];
        }

        async function deleteHafalan(id) {
            const { error } = await supabase
                .from('hafalan')
                .delete()
                .eq('id', id);
            
            if (error) throw error;
        }

        async function createKesantrian(kesantrianData) {
            const { data, error } = await supabase
                .from('kesantrian')
                .insert([kesantrianData])
                .select();
            
            if (error) throw error;
            return data[0];
        }

        async function updateKesantrian(id, kesantrianData) {
            try {
                // Ambil data lama untuk menghitung perbedaan poin
                const { data: oldData } = await supabase
                    .from('kesantrian')
                    .select('pengurangan_poin, santri_id')
                    .eq('id', id)
                    .single();
                
                // Update data kesantrian
                const { data, error } = await supabase
                    .from('kesantrian')
                    .update(kesantrianData)
                    .eq('id', id)
                    .select();
                
                if (error) throw error;
                
                // Update poin santri jika ada perubahan pengurangan poin
                if (oldData && kesantrianData.pengurangan_poin !== undefined) {
                    const selisihPoin = kesantrianData.pengurangan_poin - oldData.pengurangan_poin;
                    const santri = santriData.find(s => s.id === oldData.santri_id);
                    
                    if (santri) {
                        const newPoin = Math.max(0, santri.poin_kesantrian - selisihPoin);
                        await supabase
                            .from('profiles')
                            .update({ poin_kesantrian: newPoin })
                            .eq('id', oldData.santri_id);
                    }
                }
                
                return data[0];
            } catch (error) {
                throw error;
            }
        }

        async function deleteKesantrian(id) {
            try {
                // Ambil data sebelum hapus
                const { data: kesantrian } = await supabase
                    .from('kesantrian')
                    .select('pengurangan_poin, santri_id')
                    .eq('id', id)
                    .single();
                
                // Hapus data
                const { error } = await supabase
                    .from('kesantrian')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                // Kembalikan poin santri
                if (kesantrian) {
                    const santri = santriData.find(s => s.id === kesantrian.santri_id);
                    if (santri) {
                        const newPoin = Math.min(100, santri.poin_kesantrian + kesantrian.pengurangan_poin);
                        await supabase
                            .from('profiles')
                            .update({ poin_kesantrian: newPoin })
                            .eq('id', kesantrian.santri_id);
                    }
                }
            } catch (error) {
                throw error;
            }
        }

        async function createKasus(kasusData) {
            const { data, error } = await supabase
                .from('kasus')
                .insert([kasusData])
                .select();
            
            if (error) throw error;
            return data[0];
        }

        async function updateKasus(id, kasusData) {
            try {
                // Ambil data lama
                const { data: oldData } = await supabase
                    .from('kasus')
                    .select('pengurangan_poin, santri_id')
                    .eq('id', id)
                    .single();
                
                // Update data kasus
                const { data, error } = await supabase
                    .from('kasus')
                    .update(kasusData)
                    .eq('id', id)
                    .select();
                
                if (error) throw error;
                
                // Update poin santri jika ada perubahan
                if (oldData && kasusData.pengurangan_poin !== undefined) {
                    const selisihPoin = kasusData.pengurangan_poin - oldData.pengurangan_poin;
                    const santri = santriData.find(s => s.id === oldData.santri_id);
                    
                    if (santri) {
                        const newPoin = Math.max(0, santri.poin_kesantrian - selisihPoin);
                        await supabase
                            .from('profiles')
                            .update({ poin_kesantrian: newPoin })
                            .eq('id', oldData.santri_id);
                    }
                }
                
                return data[0];
            } catch (error) {
                throw error;
            }
        }

        async function deleteKasus(id) {
            try {
                // Ambil data sebelum hapus
                const { data: kasus } = await supabase
                    .from('kasus')
                    .select('pengurangan_poin, santri_id')
                    .eq('id', id)
                    .single();
                
                // Hapus data
                const { error } = await supabase
                    .from('kasus')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                // Kembalikan poin santri
                if (kasus) {
                    const santri = santriData.find(s => s.id === kasus.santri_id);
                    if (santri) {
                        const newPoin = Math.min(100, santri.poin_kesantrian + kasus.pengurangan_poin);
                        await supabase
                            .from('profiles')
                            .update({ poin_kesantrian: newPoin })
                            .eq('id', kasus.santri_id);
                    }
                }
            } catch (error) {
                throw error;
            }
        }

        async function createPelanggaran(pelanggaranData) {
            const { data, error } = await supabase
                .from('pelanggaran')
                .insert([pelanggaranData])
                .select();
            
            if (error) throw error;
            return data[0];
        }

        async function updatePelanggaran(id, pelanggaranData) {
            try {
                // Ambil data lama
                const { data: oldData } = await supabase
                    .from('pelanggaran')
                    .select('jenis_pelanggaran_id, santri_id')
                    .eq('id', id)
                    .single();
                
                // Update data pelanggaran
                const { data, error } = await supabase
                    .from('pelanggaran')
                    .update(pelanggaranData)
                    .eq('id', id)
                    .select();
                
                if (error) throw error;
                
                // Update poin santri jika jenis pelanggaran berubah
                if (oldData && pelanggaranData.jenis_pelanggaran_id !== undefined) {
                    const oldJenis = jenisPelanggaranData.find(j => j.id === oldData.jenis_pelanggaran_id);
                    const newJenis = jenisPelanggaranData.find(j => j.id === pelanggaranData.jenis_pelanggaran_id);
                    
                    if (oldJenis && newJenis) {
                        const selisihPoin = newJenis.pengurangan_point - oldJenis.pengurangan_point;
                        const santri = santriData.find(s => s.id === oldData.santri_id);
                        
                        if (santri) {
                            const newPoin = Math.max(0, santri.poin_kesantrian - selisihPoin);
                            await supabase
                                .from('profiles')
                                .update({ poin_kesantrian: newPoin })
                                .eq('id', oldData.santri_id);
                        }
                    }
                }
                
                return data[0];
            } catch (error) {
                throw error;
            }
        }

        async function deletePelanggaran(id) {
            try {
                // Ambil data sebelum hapus
                const { data: pelanggaran } = await supabase
                    .from('pelanggaran')
                    .select('jenis_pelanggaran_id, santri_id')
                    .eq('id', id)
                    .single();
                
                // Hapus data
                const { error } = await supabase
                    .from('pelanggaran')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                // Kembalikan poin santri
                if (pelanggaran) {
                    const jenis = jenisPelanggaranData.find(j => j.id === pelanggaran.jenis_pelanggaran_id);
                    const santri = santriData.find(s => s.id === pelanggaran.santri_id);
                    
                    if (jenis && santri) {
                        const newPoin = Math.min(100, santri.poin_kesantrian + jenis.pengurangan_point);
                        await supabase
                            .from('profiles')
                            .update({ poin_kesantrian: newPoin })
                            .eq('id', pelanggaran.santri_id);
                    }
                }
            } catch (error) {
                throw error;
            }
        }

        // Update poin santri setelah pelanggaran
        async function updatePoinSantri(santriId, penguranganPoint) {
            const santri = santriData.find(s => s.id === santriId);
            if (santri) {
                const newPoints = Math.max(0, santri.poin_kesantrian - penguranganPoint);
                const { error } = await supabase
                    .from('profiles')
                    .update({ poin_kesantrian: newPoints })
                    .eq('id', santri.id);
                
                if (error) throw error;
                return newPoints;
            }
            return santri.poin_kesantrian;
        }

        // Fungsi update semua poin santri
        async function updateAllSantriPoints() {
            try {
                // Ambil semua santri
                const { data: santris, error } = await supabase
                    .from('profiles')
                    .select('*');
                
                if (error) throw error;
                
                // Update poin untuk setiap santri
                for (const santri of santris) {
                    let totalPengurangan = 0;
                    
                    // Hitung pengurangan dari kesantrian
                    const { data: kesantrian } = await supabase
                        .from('kesantrian')
                        .select('pengurangan_poin')
                        .eq('santri_id', santri.id);
                    
                    if (kesantrian) {
                        totalPengurangan += kesantrian.reduce((sum, k) => sum + k.pengurangan_poin, 0);
                    }
                    
                    // Hitung pengurangan dari kasus
                    const { data: kasus } = await supabase
                        .from('kasus')
                        .select('pengurangan_poin')
                        .eq('santri_id', santri.id);
                    
                    if (kasus) {
                        totalPengurangan += kasus.reduce((sum, k) => sum + k.pengurangan_poin, 0);
                    }
                    
                    // Hitung pengurangan dari pelanggaran
                    const { data: pelanggaran } = await supabase
                        .from('pelanggaran')
                        .select('jenis_pelanggaran(pengurangan_point)')
                        .eq('santri_id', santri.id);
                    
                    if (pelanggaran) {
                        totalPengurangan += pelanggaran.reduce((sum, p) => sum + p.jenis_pelanggaran.pengurangan_point, 0);
                    }
                    
                    // Update poin santri
                    const newPoin = Math.max(0, 100 - totalPengurangan);
                    await supabase
                        .from('profiles')
                        .update({ poin_kesantrian: newPoin })
                        .eq('id', santri.id);
                }
                
                // Reload data santri
                await loadSantriData();
                
            } catch (error) {
                console.error('Error updating santri points:', error);
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Authentication
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                await handleLogin(email, password);
            });

            logoutBtn.addEventListener('click', handleLogout);

            // Tab Navigation
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetId = this.id.replace('tab-', '');
                    
                    // Update active tab
                    tabButtons.forEach(btn => btn.classList.remove('active-tab'));
                    this.classList.add('active-tab');
                    
                    // Show target section
                    contentSections.forEach(section => {
                        section.classList.add('hidden');
                    });
                    const targetSection = document.getElementById(targetId);
                    targetSection.classList.remove('hidden');
                    targetSection.classList.add('fade-in');
                });
            });

            // Data Santri
            tambahSantriBtn.addEventListener('click', function() {
                formTambahSantri.classList.remove('hidden');
            });

            batalTambah.addEventListener('click', function() {
                formTambahSantri.classList.add('hidden');
                santriForm.reset();
                document.getElementById('tanggal-masuk').valueAsDate = new Date();
            });

            santriForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    showLoading(santriForm, true);
                    
                    const santriData = {
                        nama_lengkap: document.getElementById('nama-santri').value,
                        kelas: document.getElementById('kelas-santri').value,
                        asal: document.getElementById('asal-santri').value,
                        umur: parseInt(document.getElementById('umur-santri').value),
                        tanggal_masuk: document.getElementById('tanggal-masuk').value,
                        nama_wali: document.getElementById('nama-wali').value,
                        poin_kesantrian: 100
                    };
                    
                    await createSantri(santriData);
                    
                    formTambahSantri.classList.add('hidden');
                    santriForm.reset();
                    document.getElementById('tanggal-masuk').valueAsDate = new Date();
                    
                    // Reload data
                    await loadSantriData();
                    updateSantriDropdowns();
                    loadSantriTable();
                    loadDashboardData();
                    
                    showMessage('Santri berhasil ditambahkan!', 'success');
                } catch (error) {
                    console.error('Error creating santri:', error);
                    showMessage('Gagal menambahkan santri: ' + error.message, 'error');
                } finally {
                    showLoading(santriForm, false);
                }
            });

            // Edit Santri Form
            editSantriForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    showLoading(editSantriForm, true);
                    
                    const id = document.getElementById('edit-santri-id').value;
                    const santriData = {
                        nama_lengkap: document.getElementById('edit-nama-santri').value,
                        kelas: document.getElementById('edit-kelas-santri').value,
                        asal: document.getElementById('edit-asal-santri').value,
                        umur: parseInt(document.getElementById('edit-umur-santri').value),
                        tanggal_masuk: document.getElementById('edit-tanggal-masuk').value,
                        nama_wali: document.getElementById('edit-nama-wali').value,
                        poin_kesantrian: parseInt(document.getElementById('edit-poin-santri').value)
                    };
                    
                    await updateSantri(id, santriData);
                    
                    modalEditSantri.classList.add('hidden');
                    editSantriForm.reset();
                    
                    // Reload data
                    await loadSantriData();
                    updateSantriDropdowns();
                    loadSantriTable();
                    loadDashboardData();
                    
                    showMessage('Data santri berhasil diperbarui!', 'success');
                } catch (error) {
                    console.error('Error updating santri:', error);
                    showMessage('Gagal memperbarui data santri: ' + error.message, 'error');
                } finally {
                    showLoading(editSantriForm, false);
                }
            });

            // Edit Santri Modal Controls
            closeEditModal.addEventListener('click', function() {
                modalEditSantri.classList.add('hidden');
            });

            batalEdit.addEventListener('click', function() {
                modalEditSantri.classList.add('hidden');
            });

            // Absensi
            absenForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    showLoading(absenForm, true);
                    
                    const absensiData = {
                        santri_id: santriAbsenSelect.value,
                        tanggal: document.getElementById('tanggal-absen').value,
                        status: document.getElementById('status-absen').value,
                        keterangan: document.getElementById('keterangan-absen').value || null
                    };
                    
                    await createAbsensi(absensiData);
                    
                    absenForm.reset();
                    document.getElementById('tanggal-absen').valueAsDate = new Date();
                    
                    // Reload data
                    await loadAbsensiData();
                    loadAbsensiTable();
                    loadDashboardData();
                    
                    showMessage('Absensi berhasil disimpan!', 'success');
                } catch (error) {
                    console.error('Error creating absensi:', error);
                    showMessage('Gagal menyimpan absensi: ' + error.message, 'error');
                } finally {
                    showLoading(absenForm, false);
                }
            });

            // Edit Absensi Form
            editAbsensiForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    showLoading(editAbsensiForm, true);
                    
                    const id = document.getElementById('edit-absensi-id').value;
                    const absensiData = {
                        tanggal: document.getElementById('edit-tanggal-absensi').value,
                        status: document.getElementById('edit-status-absensi').value,
                        keterangan: document.getElementById('edit-keterangan-absensi').value || null
                    };
                    
                    await updateAbsensi(id, absensiData);
                    
                    modalEditAbsensi.classList.add('hidden');
                    editAbsensiForm.reset();
                    
                    // Reload data
                    await loadAbsensiData();
                    loadAbsensiTable();
                    loadDashboardData();
                    
                    showMessage('Data absensi berhasil diperbarui!', 'success');
                } catch (error) {
                    console.error('Error updating absensi:', error);
                    showMessage('Gagal memperbarui data absensi: ' + error.message, 'error');
                } finally {
                    showLoading(editAbsensiForm, false);
                }
            });

            // Edit Absensi Modal Controls
            closeEditAbsensiModal.addEventListener('click', function() {
                modalEditAbsensi.classList.add('hidden');
            });

            batalEditAbsensi.addEventListener('click', function() {
                modalEditAbsensi.classList.add('hidden');
            });

            // Hafalan
            hafalanForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    showLoading(hafalanForm, true);
                    
                    const hafalanData = {
                        santri_id: santriHafalanSelect.value,
                        tanggal: document.getElementById('tanggal-hafalan').value,
                        halaman_awal: parseInt(document.getElementById('halaman-awal').value),
                        halaman_akhir: parseInt(document.getElementById('halaman-akhir').value),
                        catatan: document.getElementById('catatan-hafalan').value || null
                    };
                    
                    await createHafalan(hafalanData);
                    
                    hafalanForm.reset();
                    document.getElementById('tanggal-hafalan').valueAsDate = new Date();
                    
                    // Reload data
                    await loadHafalanData();
                    loadHafalanTable();
                    loadDashboardData();
                    
                    showMessage('Setoran hafalan berhasil disimpan!', 'success');
                } catch (error) {
                    console.error('Error creating hafalan:', error);
                    showMessage('Gagal menyimpan setoran hafalan: ' + error.message, 'error');
                } finally {
                    showLoading(hafalanForm, false);
                }
            });

            // Edit Hafalan Form
            editHafalanForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    showLoading(editHafalanForm, true);
                    
                    const id = document.getElementById('edit-hafalan-id').value;
                    const hafalanData = {
                        tanggal: document.getElementById('edit-tanggal-hafalan').value,
                        halaman_awal: parseInt(document.getElementById('edit-halaman-awal').value),
                        halaman_akhir: parseInt(document.getElementById('edit-halaman-akhir').value),
                        catatan: document.getElementById('edit-catatan-hafalan').value || null
                    };
                    
                    await updateHafalan(id, hafalanData);
                    
                    modalEditHafalan.classList.add('hidden');
                    editHafalanForm.reset();
                    
                    // Reload data
                    await loadHafalanData();
                    loadHafalanTable();
                    loadDashboardData();
                    
                    showMessage('Data hafalan berhasil diperbarui!', 'success');
                } catch (error) {
                    console.error('Error updating hafalan:', error);
                    showMessage('Gagal memperbarui data hafalan: ' + error.message, 'error');
                } finally {
                    showLoading(editHafalanForm, false);
                }
            });

            // Edit Hafalan Modal Controls
            closeEditHafalanModal.addEventListener('click', function() {
                modalEditHafalan.classList.add('hidden');
            });

            batalEditHafalan.addEventListener('click', function() {
                modalEditHafalan.classList.add('hidden');
            });

            // Kesantrian
            kesantrianForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    showLoading(kesantrianForm, true);
                    
                    // Calculate point reduction
                    const sikap = document.getElementById('sikap-kesantrian').value;
                    const disiplin = document.getElementById('disiplin-kesantrian').value;
                    const kebersihan = document.getElementById('kebersihan-kesantrian').value;
                    
                    let pengurangan_poin = 0;
                    if (sikap === 'kurang') pengurangan_poin += 5;
                    if (sikap === 'cukup') pengurangan_poin += 2;
                    if (disiplin === 'kurang') pengurangan_poin += 5;
                    if (disiplin === 'cukup') pengurangan_poin += 2;
                    if (kebersihan === 'kurang') pengurangan_poin += 5;
                    if (kebersihan === 'cukup') pengurangan_poin += 2;
                    
                    const kesantrianData = {
                        santri_id: santriKesantrianSelect.value,
                        tanggal: document.getElementById('tanggal-kesantrian').value,
                        sikap: sikap,
                        disiplin: disiplin,
                        kebersihan: kebersihan,
                        pelanggaran: document.getElementById('pelanggaran-kesantrian').value || null,
                        catatan: document.getElementById('catatan-kesantrian').value || null,
                        pengurangan_poin: pengurangan_poin
                    };
                    
                    await createKesantrian(kesantrianData);
                    
                    // Update santri points
                    const santri = santriData.find(s => s.id === santriKesantrianSelect.value);
                    if (santri) {
                        const newPoints = Math.max(0, santri.poin_kesantrian - pengurangan_poin);
                        const { error } = await supabase
                            .from('profiles')
                            .update({ poin_kesantrian: newPoints })
                            .eq('id', santri.id);
                        
                        if (error) throw error;
                    }
                    
                    kesantrianForm.reset();
                    document.getElementById('tanggal-kesantrian').valueAsDate = new Date();
                    
                    // Reload data
                    await loadSantriData();
                    await loadKesantrianData();
                    loadKesantrianTable();
                    loadSantriTable();
                    loadDashboardData();
                    
                    showMessage('Penilaian kesantrian berhasil disimpan!', 'success');
                } catch (error) {
                    console.error('Error creating kesantrian:', error);
                    showMessage('Gagal menyimpan penilaian kesantrian: ' + error.message, 'error');
                } finally {
                    showLoading(kesantrianForm, false);
                }
            });

            // Edit Kesantrian Form
            editKesantrianForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    showLoading(editKesantrianForm, true);
                    
                    const id = document.getElementById('edit-kesantrian-id').value;
                    
                    // Calculate point reduction
                    const sikap = document.getElementById('edit-sikap-kesantrian').value;
                    const disiplin = document.getElementById('edit-disiplin-kesantrian').value;
                    const kebersihan = document.getElementById('edit-kebersihan-kesantrian').value;
                    
                    let pengurangan_poin = 0;
                    if (sikap === 'kurang') pengurangan_poin += 5;
                    if (sikap === 'cukup') pengurangan_poin += 2;
                    if (disiplin === 'kurang') pengurangan_poin += 5;
                    if (disiplin === 'cukup') pengurangan_poin += 2;
                    if (kebersihan === 'kurang') pengurangan_poin += 5;
                    if (kebersihan === 'cukup') pengurangan_poin += 2;
                    
                    const kesantrianData = {
                        tanggal: document.getElementById('edit-tanggal-kesantrian').value,
                        sikap: sikap,
                        disiplin: disiplin,
                        kebersihan: kebersihan,
                        pelanggaran: document.getElementById('edit-pelanggaran-kesantrian').value || null,
                        catatan: document.getElementById('edit-catatan-kesantrian').value || null,
                        pengurangan_poin: pengurangan_poin
                    };
                    
                    await updateKesantrian(id, kesantrianData);
                    
                    modalEditKesantrian.classList.add('hidden');
                    editKesantrianForm.reset();
                    
                    // Reload data
                    await loadSantriData();
                    await loadKesantrianData();
                    loadKesantrianTable();
                    loadSantriTable();
                    loadDashboardData();
                    
                    showMessage('Data kesantrian berhasil diperbarui!', 'success');
                } catch (error) {
                    console.error('Error updating kesantrian:', error);
                    showMessage('Gagal memperbarui data kesantrian: ' + error.message, 'error');
                } finally {
                    showLoading(editKesantrianForm, false);
                }
            });

            // Edit Kesantrian Modal Controls
            closeEditKesantrianModal.addEventListener('click', function() {
                modalEditKesantrian.classList.add('hidden');
            });

            batalEditKesantrian.addEventListener('click', function() {
                modalEditKesantrian.classList.add('hidden');
            });

            // Kasus
            kasusForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    showLoading(kasusForm, true);
                    
                    const kasusData = {
                        santri_id: santriKasusSelect.value,
                        tanggal: document.getElementById('tanggal-kasus').value,
                        deskripsi_kasus: document.getElementById('deskripsi-kasus').value,
                        penanganan: document.getElementById('penanganan-kasus').value,
                        pengurangan_poin: parseInt(document.getElementById('poin-kasus').value)
                    };
                    
                    await createKasus(kasusData);
                    
                    // Update santri points
                    const santri = santriData.find(s => s.id === santriKasusSelect.value);
                    if (santri) {
                        const newPoints = Math.max(0, santri.poin_kesantrian - kasusData.pengurangan_poin);
                        const { error } = await supabase
                            .from('profiles')
                            .update({ poin_kesantrian: newPoints })
                            .eq('id', santri.id);
                        
                        if (error) throw error;
                    }
                    
                    kasusForm.reset();
                    document.getElementById('tanggal-kasus').valueAsDate = new Date();
                    document.getElementById('poin-kasus').value = 0;
                    
                    // Reload data
                    await loadSantriData();
                    await loadKasusData();
                    loadKasusTable();
                    loadSantriTable();
                    loadDashboardData();
                    
                    showMessage('Kasus berhasil disimpan!', 'success');
                } catch (error) {
                    console.error('Error creating kasus:', error);
                    showMessage('Gagal menyimpan kasus: ' + error.message, 'error');
                } finally {
                    showLoading(kasusForm, false);
                }
            });

            // Edit Kasus Form
            editKasusForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    showLoading(editKasusForm, true);
                    
                    const id = document.getElementById('edit-kasus-id').value;
                    const kasusData = {
                        tanggal: document.getElementById('edit-tanggal-kasus').value,
                        deskripsi_kasus: document.getElementById('edit-deskripsi-kasus').value,
                        penanganan: document.getElementById('edit-penanganan-kasus').value,
                        pengurangan_poin: parseInt(document.getElementById('edit-poin-kasus').value)
                    };
                    
                    await updateKasus(id, kasusData);
                    
                    modalEditKasus.classList.add('hidden');
                    editKasusForm.reset();
                    
                    // Reload data
                    await loadSantriData();
                    await loadKasusData();
                    loadKasusTable();
                    loadSantriTable();
                    loadDashboardData();
                    
                    showMessage('Data kasus berhasil diperbarui!', 'success');
                } catch (error) {
                    console.error('Error updating kasus:', error);
                    showMessage('Gagal memperbarui data kasus: ' + error.message, 'error');
                } finally {
                    showLoading(editKasusForm, false);
                }
            });

            // Edit Kasus Modal Controls
            closeEditKasusModal.addEventListener('click', function() {
                modalEditKasus.classList.add('hidden');
            });

            batalEditKasus.addEventListener('click', function() {
                modalEditKasus.classList.add('hidden');
            });

            // Pelanggaran
            pelanggaranForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    showLoading(pelanggaranForm, true);
                    
                    const jenisPelanggaranId = document.getElementById('jenis-pelanggaran').value;
                    const selectedJenis = jenisPelanggaranData.find(j => j.id === jenisPelanggaranId);
                    
                    const pelanggaranData = {
                        santri_id: document.getElementById('santri-pelanggaran').value,
                        jenis_pelanggaran_id: jenisPelanggaranId,
                        tanggal: document.getElementById('tanggal-pelanggaran').value,
                        deskripsi: document.getElementById('deskripsi-pelanggaran').value,
                        sanksi_fisik_diberikan: document.getElementById('sanksi-fisik').value || null,
                        point_sebelum: santriData.find(s => s.id === document.getElementById('santri-pelanggaran').value).poin_kesantrian,
                        point_sesudah: 0 // akan diupdate
                    };
                    
                    // Create pelanggaran
                    await createPelanggaran(pelanggaranData);
                    
                    // Update poin santri
                    const newPoints = await updatePoinSantri(
                        pelanggaranData.santri_id, 
                        selectedJenis.pengurangan_point
                    );
                    
                    pelanggaranData.point_sesudah = newPoints;
                    
                    // Update record dengan point_sesudah
                    await supabase
                        .from('pelanggaran')
                        .update({ point_sesudah: newPoints })
                        .eq('santri_id', pelanggaranData.santri_id)
                        .eq('tanggal', pelanggaranData.tanggal);
                    
                    // Reset form
                    pelanggaranForm.reset();
                    document.getElementById('tanggal-pelanggaran').valueAsDate = new Date();
                    document.getElementById('info-sanksi').innerHTML = 'Pilih jenis pelanggaran untuk melihat informasi sanksi';
                    
                    // Reload data
                    await loadSantriData();
                    await loadPelanggaranData();
                    loadPelanggaranTable();
                    loadSantriTable();
                    loadDashboardData();
                    
                    showMessage('Pelanggaran berhasil dicatat!', 'success');
                } catch (error) {
                    console.error('Error creating pelanggaran:', error);
                    showMessage('Gagal mencatat pelanggaran: ' + error.message, 'error');
                } finally {
                    showLoading(pelanggaranForm, false);
                }
            });

            // Edit Pelanggaran Form
            editPelanggaranForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    showLoading(editPelanggaranForm, true);
                    
                    const id = document.getElementById('edit-pelanggaran-id').value;
                    const jenisPelanggaranId = document.getElementById('edit-jenis-pelanggaran').value;
                    const selectedJenis = jenisPelanggaranData.find(j => j.id === jenisPelanggaranId);
                    
                    const pelanggaranData = {
                        jenis_pelanggaran_id: jenisPelanggaranId,
                        tanggal: document.getElementById('edit-tanggal-pelanggaran').value,
                        deskripsi: document.getElementById('edit-deskripsi-pelanggaran').value,
                        sanksi_fisik_diberikan: document.getElementById('edit-sanksi-fisik').value || null
                    };
                    
                    await updatePelanggaran(id, pelanggaranData);
                    
                    modalEditPelanggaran.classList.add('hidden');
                    editPelanggaranForm.reset();
                    
                    // Reload data
                    await loadSantriData();
                    await loadPelanggaranData();
                    loadPelanggaranTable();
                    
                    showMessage('Data pelanggaran berhasil diperbarui!', 'success');
                } catch (error) {
                    console.error('Error updating pelanggaran:', error);
                    showMessage('Gagal memperbarui data pelanggaran: ' + error.message, 'error');
                } finally {
                    showLoading(editPelanggaranForm, false);
                }
            });

            // Edit Pelanggaran Modal Controls
            closeEditPelanggaranModal.addEventListener('click', function() {
                modalEditPelanggaran.classList.add('hidden');
            });

            batalEditPelanggaran.addEventListener('click', function() {
                modalEditPelanggaran.classList.add('hidden');
            });

            // Hapus Modal Controls
            closeHapusModal.addEventListener('click', function() {
                modalHapus.classList.add('hidden');
            });

            batalHapus.addEventListener('click', function() {
                modalHapus.classList.add('hidden');
            });

            konfirmasiHapus.addEventListener('click', async function() {
                try {
                    if (currentEditId && currentEditType) {
                        switch (currentEditType) {
                            case 'santri':
                                await deleteSantri(currentEditId);
                                await loadSantriData();
                                updateSantriDropdowns();
                                loadSantriTable();
                                loadDashboardData();
                                showMessage('Data santri berhasil dihapus!', 'success');
                                break;
                            case 'absensi':
                                await deleteAbsensi(currentEditId);
                                await loadAbsensiData();
                                loadAbsensiTable();
                                loadDashboardData();
                                showMessage('Data absensi berhasil dihapus!', 'success');
                                break;
                            case 'hafalan':
                                await deleteHafalan(currentEditId);
                                await loadHafalanData();
                                loadHafalanTable();
                                loadDashboardData();
                                showMessage('Data hafalan berhasil dihapus!', 'success');
                                break;
                            case 'kesantrian':
                                await deleteKesantrian(currentEditId);
                                await loadSantriData();
                                await loadKesantrianData();
                                loadKesantrianTable();
                                loadSantriTable();
                                loadDashboardData();
                                showMessage('Data kesantrian berhasil dihapus!', 'success');
                                break;
                            case 'kasus':
                                await deleteKasus(currentEditId);
                                await loadSantriData();
                                await loadKasusData();
                                loadKasusTable();
                                loadSantriTable();
                                loadDashboardData();
                                showMessage('Data kasus berhasil dihapus!', 'success');
                                break;
                            case 'pelanggaran':
                                await deletePelanggaran(currentEditId);
                                await loadSantriData();
                                await loadPelanggaranData();
                                loadPelanggaranTable();
                                loadSantriTable();
                                loadDashboardData();
                                showMessage('Data pelanggaran berhasil dihapus!', 'success');
                                break;
                        }
                    }
                    
                    modalHapus.classList.add('hidden');
                    currentEditId = null;
                    currentEditType = null;
                } catch (error) {
                    console.error('Error deleting data:', error);
                    showMessage('Gagal menghapus data: ' + error.message, 'error');
                }
            });

            // Event listener untuk perubahan jenis pelanggaran
            jenisPelanggaranSelect.addEventListener('change', function() {
                const selectedId = this.value;
                const selectedJenis = jenisPelanggaranData.find(j => j.id === selectedId);
                
                if (selectedJenis) {
                    infoSanksi.innerHTML = `
                        <strong>${selectedJenis.kode}</strong><br>
                        <strong>Pengurangan Point:</strong> ${selectedJenis.pengurangan_point}<br>
                        <strong>Sanksi Fisik:</strong> ${selectedJenis.sanksi_fisik || 'Tidak ada sanksi fisik'}
                    `;
                }
            });

            // Event listener untuk perubahan jenis pelanggaran di edit modal
            document.getElementById('edit-jenis-pelanggaran').addEventListener('change', function() {
                const selectedId = this.value;
                const selectedJenis = jenisPelanggaranData.find(j => j.id === selectedId);
                
                if (selectedJenis) {
                    document.getElementById('edit-sanksi-fisik').value = selectedJenis.sanksi_fisik || '';
                }
            });

            // Filters
            if (filterAbsenBtn) {
                filterAbsenBtn.addEventListener('click', loadAbsensiTable);
            }
            if (filterHafalanBtn) {
                filterHafalanBtn.addEventListener('click', loadHafalanTable);
            }
            if (filterKesantrianBtn) {
                filterKesantrianBtn.addEventListener('click', loadKesantrianTable);
            }
            if (filterKasusBtn) {
                filterKasusBtn.addEventListener('click', loadKasusTable);
            }
            if (filterPelanggaranBtn) {
                filterPelanggaranBtn.addEventListener('click', loadPelanggaranTable);
            }

            // Modal
            closeModal.addEventListener('click', function() {
                modalSantri.classList.add('hidden');
            });

            // Export Buttons
            if (exportSantriPdfBtn) {
                exportSantriPdfBtn.addEventListener('click', () => exportToPDF('santri'));
            }
            if (exportSantriExcelBtn) {
                exportSantriExcelBtn.addEventListener('click', () => exportToExcel('santri'));
            }
            if (exportAbsenPdfBtn) {
                exportAbsenPdfBtn.addEventListener('click', () => exportToPDF('absensi'));
            }
            if (exportAbsenExcelBtn) {
                exportAbsenExcelBtn.addEventListener('click', () => exportToExcel('absensi'));
            }
            if (exportHafalanPdfBtn) {
                exportHafalanPdfBtn.addEventListener('click', () => exportToPDF('hafalan'));
            }
            if (exportHafalanExcelBtn) {
                exportHafalanExcelBtn.addEventListener('click', () => exportToExcel('hafalan'));
            }
            if (exportKesantrianPdfBtn) {
                exportKesantrianPdfBtn.addEventListener('click', () => exportToPDF('kesantrian'));
            }
            if (exportKesantrianExcelBtn) {
                exportKesantrianExcelBtn.addEventListener('click', () => exportToExcel('kesantrian'));
            }
            if (exportKasusPdfBtn) {
                exportKasusPdfBtn.addEventListener('click', () => exportToPDF('kasus'));
            }
            if (exportKasusExcelBtn) {
                exportKasusExcelBtn.addEventListener('click', () => exportToExcel('kasus'));
            }
            if (exportPelanggaranPdfBtn) {
                exportPelanggaranPdfBtn.addEventListener('click', () => exportToPDF('pelanggaran'));
            }
            if (exportPelanggaranExcelBtn) {
                exportPelanggaranExcelBtn.addEventListener('click', () => exportToExcel('pelanggaran'));
            }

            // Refresh Points Button
            const refreshPointsBtn = document.getElementById('refresh-points');
            if (refreshPointsBtn) {
                refreshPointsBtn.addEventListener('click', async function() {
                    try {
                        this.disabled = true;
                        this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Refreshing...';
                        
                        await updateAllSantriPoints();
                        
                        loadSantriTable();
                        loadDashboardData();
                        
                        showMessage('Poin santri berhasil diperbarui!', 'success');
                    } catch (error) {
                        showMessage('Gagal memperbarui poin: ' + error.message, 'error');
                    } finally {
                        this.disabled = false;
                        this.innerHTML = '<i class="fas fa-sync-alt mr-2"></i> Refresh Poin';
                    }
                });
            }
        }

        // UI Update Functions
        function updateSantriDropdowns() {
            const santriOptions = santriData.map(santri => 
                `<option value="${santri.id}">${santri.nama_lengkap}</option>`
            ).join('');
            
            const defaultOption = '<option value="">Pilih Santri</option>';
            
            if (santriAbsenSelect) santriAbsenSelect.innerHTML = defaultOption + santriOptions;
            if (santriHafalanSelect) santriHafalanSelect.innerHTML = defaultOption + santriOptions;
            if (santriKesantrianSelect) santriKesantrianSelect.innerHTML = defaultOption + santriOptions;
            if (santriKasusSelect) santriKasusSelect.innerHTML = defaultOption + santriOptions;
            if (santriPelanggaranSelect) santriPelanggaranSelect.innerHTML = defaultOption + santriOptions;
            
            // Update filter dropdowns
            const filterOptions = '<option value="">Semua Santri</option>' + santriOptions;
            if (filterSantriHafalan) filterSantriHafalan.innerHTML = filterOptions;
            if (filterSantriKesantrian) filterSantriKesantrian.innerHTML = filterOptions;
            if (filterSantriKasus) filterSantriKasus.innerHTML = filterOptions;
            if (filterSantriPelanggaran) filterSantriPelanggaran.innerHTML = filterOptions;
        }

        function updateJenisPelanggaranDropdown() {
            if (!jenisPelanggaranSelect) return;
            
            const options = jenisPelanggaranData.map(jenis => 
                `<option value="${jenis.id}">${jenis.kode} - ${jenis.deskripsi} (-${jenis.pengurangan_point} point)</option>`
            ).join('');
            
            jenisPelanggaranSelect.innerHTML = '<option value="">Pilih jenis pelanggaran...</option>' + options;
            
            // Update filter bab dropdown
            if (filterBabPelanggaran) {
                const uniqueBab = [...new Set(jenisPelanggaranData.map(j => j.kategori_pelanggaran.bab))];
                const babOptions = uniqueBab.map(bab => 
                    `<option value="${bab}">Bab ${bab}</option>`
                ).join('');
                
                filterBabPelanggaran.innerHTML = '<option value="">Semua Bab</option>' + babOptions;
            }
            
            // Update edit dropdown
            const editDropdown = document.getElementById('edit-jenis-pelanggaran');
            if (editDropdown) {
                editDropdown.innerHTML = '<option value="">Pilih jenis pelanggaran...</option>' + options;
            }
        }

        function loadSantriTable() {
            if (!santriTableBody) return;
            
            santriTableBody.innerHTML = '';
            
            if (santriData.length === 0) {
                santriTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            Tidak ada data santri
                        </td>
                    </tr>
                `;
                return;
            }
            
            santriData.forEach(santri => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${santri.nama_lengkap}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${santri.kelas}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${santri.asal}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${santri.umur}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${santri.poin_kesantrian >= 80 ? 'badge-baik' : santri.poin_kesantrian >= 60 ? 'badge-cukup' : 'badge-kurang'}">
                            ${santri.poin_kesantrian}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="text-primary hover:text-santri view-santri mr-2" data-id="${santri.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="text-warning hover:text-yellow-600 edit-santri mr-2" data-id="${santri.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-danger hover:text-red-600 delete-santri" data-id="${santri.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                santriTableBody.appendChild(row);
            });
            
            // Add event listeners to buttons
            document.querySelectorAll('.view-santri').forEach(button => {
                button.addEventListener('click', function() {
                    const santriId = this.getAttribute('data-id');
                    showSantriDetail(santriId);
                });
            });
            
            document.querySelectorAll('.edit-santri').forEach(button => {
                button.addEventListener('click', function() {
                    const santriId = this.getAttribute('data-id');
                    showEditSantriModal(santriId);
                });
            });
            
            document.querySelectorAll('.delete-santri').forEach(button => {
                button.addEventListener('click', function() {
                    const santriId = this.getAttribute('data-id');
                    showHapusModal(santriId, 'santri');
                });
            });
        }

        function loadAbsensiTable() {
            if (!absenTableBody) return;
            
            absenTableBody.innerHTML = '';
            
            let filteredAbsensi = [...absensiData];
            
            // Apply date filter if set
            if (filterTanggalAbsen && filterTanggalAbsen.value) {
                filteredAbsensi = filteredAbsensi.filter(a => a.tanggal === filterTanggalAbsen.value);
            }
            
            if (filteredAbsensi.length === 0) {
                absenTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                            Tidak ada data absensi
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredAbsensi.forEach(absensi => {
                const statusClass = {
                    'hadir': 'badge-hadir',
                    'sakit': 'badge-sakit',
                    'ijin': 'badge-ijin',
                    'pulang': 'badge-pulang'
                }[absensi.status] || 'badge-pulang';
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${formatDate(absensi.tanggal)}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-medium">${absensi.profiles.nama_lengkap}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass} capitalize">${absensi.status}</span>
                    </td>
                    <td class="px-6 py-4">${absensi.keterangan || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="text-warning hover:text-yellow-600 edit-absensi mr-2" data-id="${absensi.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-danger hover:text-red-600 delete-absensi" data-id="${absensi.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                absenTableBody.appendChild(row);
            });
            
            // Add event listeners to buttons
            document.querySelectorAll('.edit-absensi').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    showEditAbsensiModal(id);
                });
            });
            
            document.querySelectorAll('.delete-absensi').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    showHapusModal(id, 'absensi');
                });
            });
        }

        function loadHafalanTable() {
            if (!hafalanTableBody) return;
            
            hafalanTableBody.innerHTML = '';
            
            let filteredHafalan = [...hafalanData];
            
            // Apply santri filter if set
            if (filterSantriHafalan && filterSantriHafalan.value) {
                const santriId = filterSantriHafalan.value;
                filteredHafalan = filteredHafalan.filter(h => h.santri_id === santriId);
            }
            
            if (filteredHafalan.length === 0) {
                hafalanTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                            Tidak ada data hafalan
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredHafalan.forEach(hafalan => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${formatDate(hafalan.tanggal)}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-medium">${hafalan.profiles.nama_lengkap}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${hafalan.halaman_awal} - ${hafalan.halaman_akhir}</td>
                    <td class="px-6 py-4">${hafalan.catatan || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="text-warning hover:text-yellow-600 edit-hafalan mr-2" data-id="${hafalan.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-danger hover:text-red-600 delete-hafalan" data-id="${hafalan.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                hafalanTableBody.appendChild(row);
            });
            
            // Add event listeners to buttons
            document.querySelectorAll('.edit-hafalan').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    showEditHafalanModal(id);
                });
            });
            
            document.querySelectorAll('.delete-hafalan').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    showHapusModal(id, 'hafalan');
                });
            });
        }

        function loadKesantrianTable() {
            if (!kesantrianTableBody) return;
            
            kesantrianTableBody.innerHTML = '';
            
            let filteredKesantrian = [...kesantrianData];
            
            // Apply santri filter if set
            if (filterSantriKesantrian && filterSantriKesantrian.value) {
                const santriId = filterSantriKesantrian.value;
                filteredKesantrian = filteredKesantrian.filter(k => k.santri_id === santriId);
            }
            
            if (filteredKesantrian.length === 0) {
                kesantrianTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                            Tidak ada data kesantrian
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredKesantrian.forEach(kesantrian => {
                const sikapClass = getKesantrianClass(kesantrian.sikap);
                const disiplinClass = getKesantrianClass(kesantrian.disiplin);
                const kebersihanClass = getKesantrianClass(kesantrian.kebersihan);
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${formatDate(kesantrian.tanggal)}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-medium">${kesantrian.profiles.nama_lengkap}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${sikapClass} capitalize">${kesantrian.sikap}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${disiplinClass} capitalize">${kesantrian.disiplin}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${kebersihanClass} capitalize">${kesantrian.kebersihan}</span>
                    </td>
                    <td class="px-6 py-4">${kesantrian.catatan || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="text-warning hover:text-yellow-600 edit-kesantrian mr-2" data-id="${kesantrian.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-danger hover:text-red-600 delete-kesantrian" data-id="${kesantrian.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                kesantrianTableBody.appendChild(row);
            });
            
            // Add event listeners to buttons
            document.querySelectorAll('.edit-kesantrian').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    showEditKesantrianModal(id);
                });
            });
            
            document.querySelectorAll('.delete-kesantrian').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    showHapusModal(id, 'kesantrian');
                });
            });
        }

        function loadKasusTable() {
            if (!kasusTableBody) return;
            
            kasusTableBody.innerHTML = '';
            
            let filteredKasus = [...kasusData];
            
            // Apply santri filter if set
            if (filterSantriKasus && filterSantriKasus.value) {
                const santriId = filterSantriKasus.value;
                filteredKasus = filteredKasus.filter(k => k.santri_id === santriId);
            }
            
            if (filteredKasus.length === 0) {
                kasusTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            Tidak ada data kasus
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredKasus.forEach(kasus => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${formatDate(kasus.tanggal)}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-medium">${kasus.profiles.nama_lengkap}</td>
                    <td class="px-6 py-4">${kasus.deskripsi_kasus}</td>
                    <td class="px-6 py-4">${kasus.penanganan}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-red-600 font-medium">-${kasus.pengurangan_poin}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="text-warning hover:text-yellow-600 edit-kasus mr-2" data-id="${kasus.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-danger hover:text-red-600 delete-kasus" data-id="${kasus.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                kasusTableBody.appendChild(row);
            });
            
            // Add event listeners to buttons
            document.querySelectorAll('.edit-kasus').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    showEditKasusModal(id);
                });
            });
            
            document.querySelectorAll('.delete-kasus').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    showHapusModal(id, 'kasus');
                });
            });
        }

        function loadPelanggaranTable() {
            if (!pelanggaranTableBody) return;
            
            pelanggaranTableBody.innerHTML = '';
            
            let filteredPelanggaran = [...pelanggaranData];
            
            // Apply filters
            if (filterSantriPelanggaran && filterSantriPelanggaran.value) {
                filteredPelanggaran = filteredPelanggaran.filter(p => p.santri_id === filterSantriPelanggaran.value);
            }
            
            if (filterBabPelanggaran && filterBabPelanggaran.value) {
                filteredPelanggaran = filteredPelanggaran.filter(p => 
                    p.jenis_pelanggaran.kategori_pelanggaran.bab === filterBabPelanggaran.value
                );
            }
            
            if (filteredPelanggaran.length === 0) {
                pelanggaranTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            Tidak ada data pelanggaran
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredPelanggaran.forEach(pelanggaran => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${formatDate(pelanggaran.tanggal)}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-medium">${pelanggaran.profiles.nama_lengkap}</td>
                    <td class="px-6 py-4">
                        <div>
                            <span class="font-medium">${pelanggaran.jenis_pelanggaran.kode}</span>
                            <p class="text-sm text-gray-600">${pelanggaran.jenis_pelanggaran.deskripsi}</p>
                            ${pelanggaran.deskripsi ? `<p class="text-xs text-gray-500 mt-1">${pelanggaran.deskripsi}</p>` : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-red-600 font-medium">-${pelanggaran.jenis_pelanggaran.pengurangan_point}</td>
                    <td class="px-6 py-4">
                        <p class="text-sm">${pelanggaran.jenis_pelanggaran.sanksi_fisik || '-'}</p>
                        ${pelanggaran.sanksi_fisik_diberikan ? `<p class="text-xs text-gray-500 mt-1">Diberikan: ${pelanggaran.sanksi_fisik_diberikan}</p>` : ''}
                    </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                        <button class="text-warning hover:text-yellow-600 edit-pelanggaran mr-2" data-id="${pelanggaran.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-danger hover:text-red-600 delete-pelanggaran" data-id="${pelanggaran.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                pelanggaranTableBody.appendChild(row);
            });
            
            // Add event listeners to buttons
            document.querySelectorAll('.edit-pelanggaran').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    showEditPelanggaranModal(id);
                });
            });
            
            document.querySelectorAll('.delete-pelanggaran').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    showHapusModal(id, 'pelanggaran');
                });
            });
        }

        // Load kategori pelanggaran
        async function loadKategoriView() {
            if (!kategoriPelanggaranElement) return;
            
            const kategori = await loadKategoriPelanggaran();
            
            kategoriPelanggaranElement.innerHTML = '';
            
            if (kategori.length === 0) {
                kategoriPelanggaranElement.innerHTML = '<p class="text-center text-gray-500 py-4">Tidak ada data kategori</p>';
                return;
            }
            
            kategori.forEach(kat => {
                const jenisInKategori = jenisPelanggaranData.filter(j => j.kategori_id === kat.id);
                
                const kategoriElement = document.createElement('div');
                kategoriElement.className = 'bg-gray-50 rounded-lg p-4';
                kategoriElement.innerHTML = `
                    <h4 class="font-semibold text-gray-800 mb-3">${kat.bab}. ${kat.nama_bab}</h4>
                    <div class="space-y-2 max-h-60 overflow-y-auto">
                        ${jenisInKategori.map(j => `
                            <div class="bg-white rounded p-3 border border-gray-200">
                                <div class="flex justify-between items-start">
                                    <span class="font-medium text-sm">${j.kode}</span>
                                    <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">-${j.pengurangan_point}</span>
                                </div>
                                <p class="text-xs text-gray-600 mt-1">${j.deskripsi}</p>
                                ${j.sanksi_fisik ? `<p class="text-xs text-yellow-600 mt-1">Sanksi: ${j.sanksi_fisik}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
                kategoriPelanggaranElement.appendChild(kategoriElement);
            });
        }

        // Dashboard Functions
        function loadDashboardData() {
            // Total Santri
            totalSantriElement.textContent = santriData.length;
            
            // Hadir Hari Ini
            const today = new Date().toISOString().split('T')[0];
            const hadirHariIni = absensiData.filter(a => a.tanggal === today && a.status === 'hadir').length;
            hadirHariIniElement.textContent = hadirHariIni;
            
            // Total Halaman Hafalan
            const totalHalaman = hafalanData.reduce((total, h) => total + (h.halaman_akhir - h.halaman_awal + 1), 0);
            totalHalamanElement.textContent = totalHalaman;
            
            // Total Pelanggaran
            totalPelanggaranElement.textContent = pelanggaranData.length;
            
            // Recent Activities
            loadRecentActivities();
            
            // Top Santri
            loadTopSantri();
            
            // Santri dengan poin rendah
            loadLowPointSantri();
        }

        function loadRecentActivities() {
            if (!recentActivitiesElement) return;
            
            recentActivitiesElement.innerHTML = '';
            
            // Combine all activities and sort by date
            const allActivities = [
                ...absensiData.map(a => ({...a, type: 'absensi'})),
                ...hafalanData.map(h => ({...h, type: 'hafalan'})),
                ...kesantrianData.map(k => ({...k, type: 'kesantrian'})),
                ...kasusData.map(k => ({...k, type: 'kasus'})),
                ...pelanggaranData.map(p => ({...p, type: 'pelanggaran'}))
            ].sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal)).slice(0, 5);
            
            if (allActivities.length === 0) {
                recentActivitiesElement.innerHTML = '<p class="text-center text-gray-500 py-4">Tidak ada aktivitas terbaru</p>';
                return;
            }
            
            allActivities.forEach(activity => {
                let activityText = '';
                let iconClass = '';
                let bgColor = '';
                
                switch(activity.type) {
                    case 'absensi':
                        activityText = `${activity.profiles.nama_lengkap} ${activity.status}`;
                        iconClass = activity.status === 'hadir' ? 'fa-check text-green-500' : 
                                    activity.status === 'sakit' ? 'fa-procedures text-yellow-500' :
                                    activity.status === 'ijin' ? 'fa-envelope text-blue-500' : 
                                    'fa-home text-gray-500';
                        bgColor = activity.status === 'hadir' ? 'bg-green-100' : 
                                 activity.status === 'sakit' ? 'bg-yellow-100' :
                                 activity.status === 'ijin' ? 'bg-blue-100' : 
                                 'bg-gray-100';
                        break;
                    case 'hafalan':
                        activityText = `${activity.profiles.nama_lengkap} setor hafalan halaman ${activity.halaman_awal}-${activity.halaman_akhir}`;
                        iconClass = 'fa-book text-purple-500';
                        bgColor = 'bg-purple-100';
                        break;
                    case 'kesantrian':
                        activityText = `${activity.profiles.nama_lengkap} dinilai kesantrian`;
                        iconClass = 'fa-clipboard-check text-indigo-500';
                        bgColor = 'bg-indigo-100';
                        break;
                    case 'kasus':
                        activityText = `${activity.profiles.nama_lengkap} memiliki kasus baru`;
                        iconClass = 'fa-exclamation-triangle text-red-500';
                        bgColor = 'bg-red-100';
                        break;
                    case 'pelanggaran':
                        activityText = `${activity.profiles.nama_lengkap} melakukan pelanggaran ${activity.jenis_pelanggaran.kode}`;
                        iconClass = 'fa-gavel text-orange-500';
                        bgColor = 'bg-orange-100';
                        break;
                }
                
                const activityElement = document.createElement('div');
                activityElement.className = 'flex items-center py-3 border-b border-gray-100 last:border-0';
                activityElement.innerHTML = `
                    <div class="flex-shrink-0 w-10 h-10 rounded-full ${bgColor} flex items-center justify-center">
                        <i class="fas ${iconClass}"></i>
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-sm font-medium text-gray-900">${activityText}</p>
                        <p class="text-xs text-gray-500">${formatDate(activity.tanggal)}</p>
                    </div>
                `;
                recentActivitiesElement.appendChild(activityElement);
            });
        }

        function loadTopSantri() {
            if (!topSantriElement) return;
            
            topSantriElement.innerHTML = '';
            
            // Sort santri by points
            const sortedSantri = [...santriData].sort((a, b) => b.poin_kesantrian - a.poin_kesantrian).slice(0, 5);
            
            if (sortedSantri.length === 0) {
                topSantriElement.innerHTML = '<p class="text-center text-gray-500 py-4">Tidak ada data santri</p>';
                return;
            }
            
            sortedSantri.forEach((santri, index) => {
                const rankClass = index === 0 ? 'bg-yellow-100 text-yellow-800 border-yellow-200' : 
                                index === 1 ? 'bg-gray-100 text-gray-800 border-gray-200' : 
                                index === 2 ? 'bg-orange-100 text-orange-800 border-orange-200' : 
                                'bg-blue-100 text-blue-800 border-blue-200';
                
                const santriElement = document.createElement('div');
                santriElement.className = 'flex items-center justify-between py-3 border-b border-gray-100 last:border-0';
                santriElement.innerHTML = `
                    <div class="flex items-center">
                        <span class="w-7 h-7 rounded-full ${rankClass} flex items-center justify-center text-sm font-bold mr-3 border">
                            ${index + 1}
                        </span>
                        <div>
                            <p class="text-sm font-medium text-gray-900">${santri.nama_lengkap}</p>
                            <p class="text-xs text-gray-500">${santri.kelas}</p>
                        </div>
                    </div>
                    <span class="text-sm font-semibold ${santri.poin_kesantrian >= 80 ? 'text-green-600' : santri.poin_kesantrian >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                        ${santri.poin_kesantrian} poin
                    </span>
                `;
                topSantriElement.appendChild(santriElement);
            });
        }

        function loadLowPointSantri() {
            if (!lowPointSantriElement) return;
            
            lowPointSantriElement.innerHTML = '';
            
            // Sort santri by points (ascending) and take the bottom 3
            const sortedSantri = [...santriData].sort((a, b) => a.poin_kesantrian - b.poin_kesantrian).slice(0, 3);
            
            if (sortedSantri.length === 0) {
                lowPointSantriElement.innerHTML = '<p class="text-center text-gray-500 py-4">Tidak ada data santri</p>';
                return;
            }
            
            sortedSantri.forEach(santri => {
                const santriElement = document.createElement('div');
                santriElement.className = 'bg-white rounded-lg shadow p-4 santri-card border-l-4 border-red-500';
                santriElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-semibold text-gray-900">${santri.nama_lengkap}</h4>
                        <span class="px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">${santri.poin_kesantrian} poin</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">${santri.kelas}  ${santri.asal}</p>
                    <div class="progress-bar">
                        <div class="progress-fill bg-red-500" style="width: ${santri.poin_kesantrian}%"></div>
                    </div>
                    <button class="mt-3 text-sm text-primary hover:text-santri view-santri w-full text-left" data-id="${santri.id}">
                        <i class="fas fa-eye mr-1"></i> Lihat detail
                    </button>
                `;
                lowPointSantriElement.appendChild(santriElement);
            });
            
            // Add event listeners to view buttons
            document.querySelectorAll('#low-point-santri .view-santri').forEach(button => {
                button.addEventListener('click', function() {
                    const santriId = this.getAttribute('data-id');
                    showSantriDetail(santriId);
                });
            });
        }

        // Santri Detail Modal
        async function showSantriDetail(santriId) {
            const santri = santriData.find(s => s.id === santriId);
            if (!santri) return;
            
            // Set basic info
            modalNamaSantri.textContent = santri.nama_lengkap;
            modalKelas.textContent = santri.kelas;
            modalAsal.textContent = santri.asal;
            modalUmur.textContent = santri.umur;
            modalPoin.textContent = santri.poin_kesantrian;
            modalPoinProgress.style.width = `${santri.poin_kesantrian}%`;
            modalTanggalMasuk.textContent = formatDate(santri.tanggal_masuk);
            modalNamaWali.textContent = santri.nama_wali;
            
            // Set hafalan statistics
            const santriHafalan = hafalanData.filter(h => h.santri_id === santriId);
            const totalHalaman = santriHafalan.reduce((total, h) => total + (h.halaman_akhir - h.halaman_awal + 1), 0);
            modalTotalHalaman.textContent = totalHalaman;
            
            const latestHafalan = santriHafalan.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal))[0];
            modalSetoranTerakhir.textContent = latestHafalan ? formatDate(latestHafalan.tanggal) : '-';
            
            // Calculate average pages per month
            const now = new Date();
            const masukDate = new Date(santri.tanggal_masuk);
            const monthsDiff = (now.getFullYear() - masukDate.getFullYear()) * 12 + (now.getMonth() - masukDate.getMonth());
            const avgHalaman = monthsDiff > 0 ? Math.round(totalHalaman / monthsDiff) : totalHalaman;
            modalRataHafalan.textContent = avgHalaman;
            
            // Set absensi data (last 30 days)
            modalAbsensi.innerHTML = '';
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const santriAbsensi = absensiData
                .filter(a => a.santri_id === santriId && new Date(a.tanggal) >= thirtyDaysAgo)
                .sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
            
            if (santriAbsensi.length === 0) {
                modalAbsensi.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Tidak ada data absensi 30 hari terakhir</p>';
            } else {
                santriAbsensi.forEach(absensi => {
                    const statusClass = {
                        'hadir': 'badge-hadir',
                        'sakit': 'badge-sakit',
                        'ijin': 'badge-ijin',
                        'pulang': 'badge-pulang'
                    }[absensi.status] || 'badge-pulang';
                    
                    const absensiElement = document.createElement('div');
                    absensiElement.className = 'flex justify-between items-center py-2 border-b border-gray-100 last:border-0';
                    absensiElement.innerHTML = `
                        <span class="text-sm text-gray-700">${formatDate(absensi.tanggal)}</span>
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass} capitalize">${absensi.status}</span>
                    `;
                    modalAbsensi.appendChild(absensiElement);
                });
            }
            
            // Set hafalan data (last 5)
            modalHafalan.innerHTML = '';
            const santriHafalanLatest = santriHafalan
                .sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal))
                .slice(0, 5);
            
            if (santriHafalanLatest.length === 0) {
                modalHafalan.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Belum ada data hafalan</p>';
            } else {
                santriHafalanLatest.forEach(hafalan => {
                    const hafalanElement = document.createElement('div');
                    hafalanElement.className = 'bg-white border border-gray-200 rounded p-3';
                    hafalanElement.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-medium text-gray-900">${formatDate(hafalan.tanggal)}</span>
                            <span class="text-xs font-medium bg-purple-100 text-purple-800 px-2 py-1 rounded">Halaman ${hafalan.halaman_awal}-${hafalan.halaman_akhir}</span>
                        </div>
                        <p class="text-xs text-gray-600">${hafalan.catatan || 'Tidak ada catatan'}</p>
                    `;
                    modalHafalan.appendChild(hafalanElement);
                });
            }
            
            // Set kesantrian data (last 5)
            modalKesantrian.innerHTML = '';
            const santriKesantrian = kesantrianData
                .filter(k => k.santri_id === santriId)
                .sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal))
                .slice(0, 5);
            
            if (santriKesantrian.length === 0) {
                modalKesantrian.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Belum ada data kesantrian</p>';
            } else {
                santriKesantrian.forEach(kesantrian => {
                    const sikapClass = getKesantrianClass(kesantrian.sikap);
                    const disiplinClass = getKesantrianClass(kesantrian.disiplin);
                    const kebersihanClass = getKesantrianClass(kesantrian.kebersihan);
                    
                    const kesantrianElement = document.createElement('div');
                    kesantrianElement.className = 'bg-white border border-gray-200 rounded p-3';
                    kesantrianElement.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-900">${formatDate(kesantrian.tanggal)}</span>
                            <span class="text-xs font-medium text-red-600">-${kesantrian.pengurangan_poin} poin</span>
                        </div>
                        <div class="flex space-x-2 mb-2">
                            <span class="px-2 py-1 rounded text-xs font-medium ${sikapClass} capitalize">Sikap: ${kesantrian.sikap}</span>
                            <span class="px-2 py-1 rounded text-xs font-medium ${disiplinClass} capitalize">Disiplin: ${kesantrian.disiplin}</span>
                            <span class="px-2 py-1 rounded text-xs font-medium ${kebersihanClass} capitalize">Kebersihan: ${kesantrian.kebersihan}</span>
                        </div>
                        <p class="text-xs text-gray-600">${kesantrian.catatan || 'Tidak ada catatan'}</p>
                    `;
                    modalKesantrian.appendChild(kesantrianElement);
                });
            }
            
            // Set kasus data (all)
            modalKasus.innerHTML = '';
            const santriKasus = kasusData
                .filter(k => k.santri_id === santriId)
                .sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
            
            if (santriKasus.length === 0) {
                modalKasus.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Tidak ada data kasus</p>';
            } else {
                santriKasus.forEach(kasus => {
                    const kasusElement = document.createElement('div');
                    kasusElement.className = 'bg-red-50 border border-red-200 rounded p-3';
                    kasusElement.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-900">${formatDate(kasus.tanggal)}</span>
                            <span class="text-xs font-medium text-red-600">-${kasus.pengurangan_poin} poin</span>
                        </div>
                        <div class="mb-2">
                            <p class="text-xs font-medium text-gray-700">Kasus:</p>
                            <p class="text-xs text-gray-600">${kasus.deskripsi_kasus}</p>
                        </div>
                        <div>
                            <p class="text-xs font-medium text-gray-700">Penanganan:</p>
                            <p class="text-xs text-gray-600">${kasus.penanganan}</p>
                        </div>
                    `;
                    modalKasus.appendChild(kasusElement);
                });
            }
            
            // Show modal
            modalSantri.classList.remove('hidden');
        }

        // Edit Modal Functions
        function showEditSantriModal(santriId) {
            const santri = santriData.find(s => s.id === santriId);
            if (!santri) return;
            
            // Fill form with data
            document.getElementById('edit-santri-id').value = santri.id;
            document.getElementById('edit-nama-santri').value = santri.nama_lengkap;
            document.getElementById('edit-kelas-santri').value = santri.kelas;
            document.getElementById('edit-asal-santri').value = santri.asal;
            document.getElementById('edit-umur-santri').value = santri.umur;
            document.getElementById('edit-tanggal-masuk').value = santri.tanggal_masuk;
            document.getElementById('edit-nama-wali').value = santri.nama_wali;
            document.getElementById('edit-poin-santri').value = santri.poin_kesantrian;
            
            // Show modal
            modalEditSantri.classList.remove('hidden');
        }

        function showEditAbsensiModal(id) {
            const absensi = absensiData.find(a => a.id === id);
            if (!absensi) return;
            
            // Fill form with data
            document.getElementById('edit-absensi-id').value = absensi.id;
            document.getElementById('edit-tanggal-absensi').value = absensi.tanggal;
            document.getElementById('edit-status-absensi').value = absensi.status;
            document.getElementById('edit-keterangan-absensi').value = absensi.keterangan || '';
            
            // Show modal
            modalEditAbsensi.classList.remove('hidden');
        }

        function showEditHafalanModal(id) {
            const hafalan = hafalanData.find(h => h.id === id);
            if (!hafalan) return;
            
            // Fill form with data
            document.getElementById('edit-hafalan-id').value = hafalan.id;
            document.getElementById('edit-tanggal-hafalan').value = hafalan.tanggal;
            document.getElementById('edit-halaman-awal').value = hafalan.halaman_awal;
            document.getElementById('edit-halaman-akhir').value = hafalan.halaman_akhir;
            document.getElementById('edit-catatan-hafalan').value = hafalan.catatan || '';
            
            // Show modal
            modalEditHafalan.classList.remove('hidden');
        }

        function showEditKesantrianModal(id) {
            const kesantrian = kesantrianData.find(k => k.id === id);
            if (!kesantrian) return;
            
            // Fill form with data
            document.getElementById('edit-kesantrian-id').value = kesantrian.id;
            document.getElementById('edit-tanggal-kesantrian').value = kesantrian.tanggal;
            document.getElementById('edit-sikap-kesantrian').value = kesantrian.sikap;
            document.getElementById('edit-disiplin-kesantrian').value = kesantrian.disiplin;
            document.getElementById('edit-kebersihan-kesantrian').value = kesantrian.kebersihan;
            document.getElementById('edit-pelanggaran-kesantrian').value = kesantrian.pelanggaran || '';
            document.getElementById('edit-catatan-kesantrian').value = kesantrian.catatan || '';
            
            // Show modal
            modalEditKesantrian.classList.remove('hidden');
        }

        function showEditKasusModal(id) {
            const kasus = kasusData.find(k => k.id === id);
            if (!kasus) return;
            
            // Fill form with data
            document.getElementById('edit-kasus-id').value = kasus.id;
            document.getElementById('edit-tanggal-kasus').value = kasus.tanggal;
            document.getElementById('edit-deskripsi-kasus').value = kasus.deskripsi_kasus;
            document.getElementById('edit-penanganan-kasus').value = kasus.penanganan;
            document.getElementById('edit-poin-kasus').value = kasus.pengurangan_poin;
            
            // Show modal
            modalEditKasus.classList.remove('hidden');
        }

        function showEditPelanggaranModal(id) {
            const pelanggaran = pelanggaranData.find(p => p.id === id);
            if (!pelanggaran) return;
            
            // Fill form with data
            document.getElementById('edit-pelanggaran-id').value = pelanggaran.id;
            document.getElementById('edit-tanggal-pelanggaran').value = pelanggaran.tanggal;
            document.getElementById('edit-jenis-pelanggaran').value = pelanggaran.jenis_pelanggaran_id;
            document.getElementById('edit-deskripsi-pelanggaran').value = pelanggaran.deskripsi || '';
            document.getElementById('edit-sanksi-fisik').value = pelanggaran.sanksi_fisik_diberikan || '';
            
            // Show modal
            modalEditPelanggaran.classList.remove('hidden');
        }

        function showHapusModal(id, type) {
            currentEditId = id;
            currentEditType = type;
            modalHapus.classList.remove('hidden');
        }

        // Export Functions
        function exportToPDF(type) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(18);
            let title = '';
            let data = [];
            let headers = [];
            
            switch(type) {
                case 'santri':
                    title = 'Data Santri';
                    headers = ['Nama', 'Kelas', 'Asal', 'Umur', 'Poin'];
                    data = santriData.map(s => [
                        s.nama_lengkap,
                        s.kelas,
                        s.asal,
                        s.umur.toString(),
                        s.poin_kesantrian.toString()
                    ]);
                    break;
                case 'absensi':
                    title = 'Data Absensi';
                    headers = ['Tanggal', 'Nama', 'Status', 'Keterangan'];
                    data = absensiData.map(a => [
                        formatDate(a.tanggal),
                        a.profiles.nama_lengkap,
                        a.status,
                        a.keterangan || '-'
                    ]);
                    break;
                case 'hafalan':
                    title = 'Data Hafalan';
                    headers = ['Tanggal', 'Nama', 'Halaman', 'Catatan'];
                    data = hafalanData.map(h => [
                        formatDate(h.tanggal),
                        h.profiles.nama_lengkap,
                        `${h.halaman_awal} - ${h.halaman_akhir}`,
                        h.catatan || '-'
                    ]);
                    break;
                case 'kesantrian':
                    title = 'Data Kesantrian';
                    headers = ['Tanggal', 'Nama', 'Sikap', 'Disiplin', 'Kebersihan', 'Catatan'];
                    data = kesantrianData.map(k => [
                        formatDate(k.tanggal),
                        k.profiles.nama_lengkap,
                        k.sikap,
                        k.disiplin,
                        k.kebersihan,
                        k.catatan || '-'
                    ]);
                    break;
                case 'kasus':
                    title = 'Data Kasus';
                    headers = ['Tanggal', 'Nama', 'Kasus', 'Penanganan', 'Poin'];
                    data = kasusData.map(k => [
                        formatDate(k.tanggal),
                        k.profiles.nama_lengkap,
                        k.deskripsi_kasus,
                        k.penanganan,
                        `-${k.pengurangan_poin}`
                    ]);
                    break;
                case 'pelanggaran':
                    title = 'Data Pelanggaran';
                    headers = ['Tanggal', 'Nama', 'Pelanggaran', 'Pengurangan', 'Sanksi'];
                    data = pelanggaranData.map(p => [
                        formatDate(p.tanggal),
                        p.profiles.nama_lengkap,
                        `${p.jenis_pelanggaran.kode} - ${p.jenis_pelanggaran.deskripsi}`,
                        `-${p.jenis_pelanggaran.pengurangan_point}`,
                        p.jenis_pelanggaran.sanksi_fisik || '-'
                    ]);
                    break;
            }
            
            doc.text(title, 14, 15);
            
            // Add table
            doc.autoTable({
                head: [headers],
                body: data,
                startY: 25,
                theme: 'grid',
                styles: {
                    fontSize: 10,
                    cellPadding: 3
                },
                headStyles: {
                    fillColor: [30, 58, 138],
                    textColor: 255
                }
            });
            
            // Save PDF
            doc.save(`${title}_${new Date().toISOString().split('T')[0]}.pdf`);
            showMessage(`Data ${title} berhasil diexport ke PDF!`, 'success');
        }

        function exportToExcel(type) {
            let title = '';
            let data = [];
            let headers = [];
            
            switch(type) {
                case 'santri':
                    title = 'Data Santri';
                    headers = ['Nama', 'Kelas', 'Asal', 'Umur', 'Tanggal Masuk', 'Nama Wali', 'Poin'];
                    data = santriData.map(s => ({
                        'Nama': s.nama_lengkap,
                        'Kelas': s.kelas,
                        'Asal': s.asal,
                        'Umur': s.umur,
                        'Tanggal Masuk': s.tanggal_masuk,
                        'Nama Wali': s.nama_wali,
                        'Poin': s.poin_kesantrian
                    }));
                    break;
                case 'absensi':
                    title = 'Data Absensi';
                    headers = ['Tanggal', 'Nama Santri', 'Status', 'Keterangan'];
                    data = absensiData.map(a => ({
                        'Tanggal': formatDate(a.tanggal),
                        'Nama Santri': a.profiles.nama_lengkap,
                        'Status': a.status,
                        'Keterangan': a.keterangan || '-'
                    }));
                    break;
                case 'hafalan':
                    title = 'Data Hafalan';
                    headers = ['Tanggal', 'Nama Santri', 'Halaman Awal', 'Halaman Akhir', 'Catatan'];
                    data = hafalanData.map(h => ({
                        'Tanggal': formatDate(h.tanggal),
                        'Nama Santri': h.profiles.nama_lengkap,
                        'Halaman Awal': h.halaman_awal,
                        'Halaman Akhir': h.halaman_akhir,
                        'Catatan': h.catatan || '-'
                    }));
                    break;
                case 'kesantrian':
                    title = 'Data Kesantrian';
                    headers = ['Tanggal', 'Nama Santri', 'Sikap', 'Disiplin', 'Kebersihan', 'Pelanggaran', 'Catatan', 'Pengurangan Poin'];
                    data = kesantrianData.map(k => ({
                        'Tanggal': formatDate(k.tanggal),
                        'Nama Santri': k.profiles.nama_lengkap,
                        'Sikap': k.sikap,
                        'Disiplin': k.disiplin,
                        'Kebersihan': k.kebersihan,
                        'Pelanggaran': k.pelanggaran || '-',
                        'Catatan': k.catatan || '-',
                        'Pengurangan Poin': k.pengurangan_poin
                    }));
                    break;
                case 'kasus':
                    title = 'Data Kasus';
                    headers = ['Tanggal', 'Nama Santri', 'Deskripsi Kasus', 'Penanganan', 'Pengurangan Poin'];
                    data = kasusData.map(k => ({
                        'Tanggal': formatDate(k.tanggal),
                        'Nama Santri': k.profiles.nama_lengkap,
                        'Deskripsi Kasus': k.deskripsi_kasus,
                        'Penanganan': k.penanganan,
                        'Pengurangan Poin': k.pengurangan_poin
                    }));
                    break;
                case 'pelanggaran':
                    title = 'Data Pelanggaran';
                    headers = ['Tanggal', 'Nama Santri', 'Kode Pelanggaran', 'Deskripsi', 'Pengurangan Point', 'Sanksi Fisik', 'Sanksi Diberikan'];
                    data = pelanggaranData.map(p => ({
                        'Tanggal': formatDate(p.tanggal),
                        'Nama Santri': p.profiles.nama_lengkap,
                        'Kode Pelanggaran': p.jenis_pelanggaran.kode,
                        'Deskripsi': p.jenis_pelanggaran.deskripsi,
                        'Pengurangan Point': p.jenis_pelanggaran.pengurangan_point,
                        'Sanksi Fisik': p.jenis_pelanggaran.sanksi_fisik || '-',
                        'Sanksi Diberikan': p.sanksi_fisik_diberikan || '-'
                    }));
                    break;
            }
            
            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, title);
            
            // Save Excel file
            XLSX.writeFile(wb, `${title}_${new Date().toISOString().split('T')[0]}.xlsx`);
            showMessage(`Data ${title} berhasil diexport ke Excel!`, 'success');
        }

        // Utility Functions
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function getKesantrianClass(value) {
            return value === 'baik' ? 'badge-baik' :
                   value === 'cukup' ? 'badge-cukup' :
                   'badge-kurang';
        }

        function showLoading(element, isLoading) {
            if (isLoading) {
                element.classList.add('loading');
                const buttons = element.querySelectorAll('button');
                buttons.forEach(button => {
                    button.disabled = true;
                    const originalText = button.innerHTML;
                    button.setAttribute('data-original-text', originalText);
                    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Loading...';
                });
            } else {
                element.classList.remove('loading');
                const buttons = element.querySelectorAll('button');
                buttons.forEach(button => {
                    button.disabled = false;
                    const originalText = button.getAttribute('data-original-text');
                    if (originalText) {
                        button.innerHTML = originalText;
                    }
                });
            }
        }

        function showMessage(message, type) {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
            }`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</body>
</html>
